<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>撈神遊戲配置生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <!-- 已移除 integrity 和 crossorigin 屬性以解決載入問題 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- JSZip for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver.js for saving the generated ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text */
            padding: 2rem;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        h1, h2, h3 {
            color: #1e3a8a; /* Dark blue for headings */
            font-weight: 700;
        }
        .section-separator {
            border-top: 1px solid #e2e8f0;
            margin-top: 2rem;
            padding-top: 2rem;
        }
        .btn-primary {
            background-color: #3b82f6; /* Blue */
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Darker blue */
        }
        .btn-secondary {
            background-color: #64748b; /* Gray */
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #475569; /* Darker gray */
        }
        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Darker red */
        }
        .input-field {
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            background-color: #ffffff; /* 更白的背景 */
            color: #1a202c; /* 更深的文字顏色 */
        }
        .image-preview {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            background-color: #fcfcfc;
        }
        .card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .drag-handle {
            cursor: grab;
            margin-right: 0.5rem;
            color: #94a3b8;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .select-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            /* 將整個 item 作為可點擊區域 */
            cursor: pointer;
        }
        .select-item:last-child {
            border-bottom: none;
        }
        .select-item img {
            width: 30px;
            height: 30px;
            margin-right: 0.5rem;
            object-fit: contain;
        }
        .select-item-name {
            font-weight: 500;
            color: #334155;
            flex-grow: 1; /* 讓名稱佔據更多空間 */
        }
        .object-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }
        /* Loader styles from storybook generator */
        #loader { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75); z-index: 9999; color: white; font-size: 1.5rem; }
        #loader-text { margin-top: 1rem; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3b82f6; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mascot Styles for Generator */
        #mascot-generator {
            position: fixed;
            bottom: 15px;
            left: 15px;
            width: 100px;
            height: auto;
            z-index: 50;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            cursor: pointer;
            transition: transform 0.2s ease-out, filter 0.2s ease-out;
        }
        #mascot-generator:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.4)) brightness(1.1);
        }
        #mascot-generator.shake {
            animation: shake-gen 0.5s ease-in-out;
        }
        @keyframes shake-gen {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            animation: particle-fly 1s ease-out forwards;
            z-index: 51; /* Above mascot */
        }
        @keyframes particle-fly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; }
        }

        /* Theme buttons for generator */
        .theme-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: 1px solid #cbd5e1;
            background-color: #f8fafc;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .theme-button:hover {
            background-color: #e2e8f0;
            border-color: #94a3b8;
            color: #1e293b;
        }
        .theme-button.active {
            background-color: #3b82f6;
            border-color: #2563eb;
            color: white;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.4);
            font-weight: 600;
        }

        /* Toast notification for mascot */
        #toast-notification {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 10000;
            pointer-events: none; /* Allow clicks to pass through */
        }
        #toast-notification.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="loader" class="flex flex-col justify-center items-center"><div class="spinner"></div><p id="loader-text">正在處理中，請稍候...</p></div>

    <div id="toast-notification" class="hidden"></div>

    <div class="container">
        <h1 class="text-4xl text-center mb-8">撈神遊戲配置生成器</h1>

        <!-- 0. 網站與遊戲基本資訊設定 -->
        <div class="mb-8 p-6 bg-purple-50 rounded-lg shadow-sm">
            <h2 class="text-2xl mb-4"><i class="fas fa-globe"></i> 網站與遊戲資訊</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="browserTitleInput" class="block text-sm font-medium text-gray-700">瀏覽器分頁標題 (&lt;title&gt;)</label>
                    <input type="text" id="browserTitleInput" class="input-field mt-1" value="雙溪撈神遊戲系統">
                </div>
                <div>
                    <label for="gameTitleInput" class="block text-sm font-medium text-gray-700">遊戲主標題 (&lt;h1&gt;)</label>
                    <input type="text" id="gameTitleInput" class="input-field mt-1" value="雙溪撈神遊戲系統">
                </div>
            </div>
            <div class="mb-4">
                <label for="copyrightTextInput" class="block text-sm font-medium text-gray-700">版權文字</label>
                <input type="text" id="copyrightTextInput" class="input-field mt-1" value="Copyright © Liyuchiutiger Gongminshen">
            </div>
        </div>

        <!-- 1. 遊戲基礎設定 -->
        <div class="mb-8 p-6 bg-blue-50 rounded-lg shadow-sm">
            <h2 class="text-2xl mb-4"><i class="fas fa-cog"></i> 遊戲基礎設定</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="scorePerCapture" class="block text-sm font-medium text-gray-700">每次成功撈取基礎分數</label>
                    <input type="number" id="scorePerCapture" class="input-field mt-1" value="100">
                </div>
                <div>
                    <label for="bonusItemScore" class="block text-sm font-medium text-gray-700">獎勵物品額外分數</label>
                    <input type="number" id="bonusItemScore" class="input-field mt-1" value="200">
                </div>
            </div>
            <div>
                <label for="scaleFactor" class="block text-sm font-medium text-gray-700">圖片顯示縮放倍數 (遊戲中實際大小 = 預設大小 * 此值)</label>
                <input type="number" id="scaleFactor" class="input-field mt-1" value="2" step="0.1">
            </div>
        </div>

        <!-- 遊戲配色風格設定 -->
        <div class="mb-8 p-6 bg-yellow-50 rounded-lg shadow-sm">
            <h2 class="text-2xl mb-4"><i class="fas fa-palette"></i> 遊戲配色風格</h2>
            <div id="theme-selection-buttons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                <!-- Theme buttons will be rendered here by JavaScript -->
            </div>
        </div>

        <!-- 2. 物品設定區 -->
        <div class="section-separator p-6 bg-gray-50 rounded-lg shadow-sm">
            <h2 class="text-2xl mb-4 flex justify-between items-center">
                <i class="fas fa-box-open"></i> 物品設定
                <button id="add-object-btn" class="btn-primary"><i class="fas fa-plus-circle"></i> 新增物品</button>
            </h2>
            <div id="object-config-list" class="object-config-grid">
                <!-- 物品配置將會動態載入這裡 -->
            </div>
        </div>

        <!-- 3. 關卡設定區 -->
        <div class="section-separator p-6 bg-green-50 rounded-lg shadow-sm">
            <h2 class="text-2xl mb-4 flex justify-between items-center">
                <i class="fas fa-sitemap"></i> 關卡設定
                <button id="add-level-btn" class="btn-primary"><i class="fas fa-plus-circle"></i> 新增關卡</button>
            </h2>
            <div id="level-config-list">
                <!-- 關卡配置將會動態載入這裡 -->
            </div>
        </div>

        <!-- 4. 生成配置區 -->
        <div class="section-separator text-center p-6 bg-indigo-50 rounded-lg shadow-sm">
            <h2 class="text-2xl mb-4"><i class="fas fa-code"></i> 生成與下載</h2>
            <div class="flex flex-col md:flex-row gap-4 justify-center mb-4">
                <button id="generate-config-btn" class="btn-primary"><i class="fas fa-sync-alt"></i> 生成配置並準備下載</button>
                <button id="download-zip-btn" class="btn-secondary" disabled><i class="fas fa-file-archive"></i> 下載遊戲 ZIP 包</button>
            </div>

            <div class="mt-8 text-left p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800">
                <h3 class="font-bold text-lg mb-2">💡 如何使用生成的 ZIP 包？</h3>
                <p class="mb-2">1. 點擊「下載遊戲 ZIP 包」按鈕，將會下載一個壓縮檔。</p>
                <p class="mb-2">2. 解壓縮此檔案，您會得到一個 `index.html`、一個 `item/` 資料夾。</p>
                <p class="mb-2">3. 將這些檔案和資料夾保持相對路徑放置。</p>
                <p class="mb-2">4. 使用任何現代瀏覽器打開 `index.html` 即可開始遊戲！</p>
                <p class="text-sm mt-3 font-bold text-red-700">
                    <i class="fas fa-exclamation-triangle"></i> 重要提示：
                    <br>如果您在 `file://` 協定（直接從硬碟打開 HTML 檔案）下運行此生成器，
                    <br>預設物品的圖片預覽可能因瀏覽器安全限制而無法顯示。
                    <br>為確保預覽正常，請將 `generator.html` 放置在一個具有 `item/` 資料夾（內含預設 SVG 圖片）的根目錄下，或者使用本地網路伺服器運行本頁面。例如：
                    <br> &nbsp; - 安裝 VS Code 的 "Live Server" 擴充功能，然後對 `generator.html` "Open with Live Server"。
                    <br> &nbsp; - 在終端機中，切換到此檔案目錄，執行 `python -m http.server`，然後瀏覽 `http://localhost:8000/generator.html`。
                </p>
            </div>
        </div>
    </div>

    <!-- 吉祥物圖片 (生成器頁面左下角固定) -->
    <div id="mascot-generator">
        <img src="image/LiyuChillGuy.svg" alt="吉祥物" class="w-full h-full" onerror="this.style.display='none'; console.error('Mascot image not found at image/LiyuChillGuy.svg in generator')">
    </div>

    <!-- 隱藏的 textarea，用於存儲 index.html 模板內容 -->
    <!-- 這解決了在 file:// 協議下無法 fetch 本地文件的問題 -->
    <textarea id="indexTemplateContent" style="display:none;">
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><!-- INSERT_BROWSER_TITLE_HERE --></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        /* Theme CSS Variables will be inserted here */
        <!-- INSERT_THEME_CSS_VARIABLES_HERE -->

        body {
            font-family: 'Inter', sans-serif;
            background: var(--body-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            color: var(--body-text-color);
            transition: background-color 0.5s;
            position: relative;
            overflow-x: hidden; /* Prevent horizontal scroll due to particle effects */
        }

        #game-wrapper {
            background-color: var(--wrapper-bg);
            backdrop-filter: blur(10px); /* 磨砂玻璃效果 */
            -webkit-backdrop-filter: blur(10px); /* 兼容 Safari */
            border-radius: 1.5rem;
            box-shadow: var(--wrapper-shadow);
            width: 95vw;
            max-width: 700px;
            padding: 1.5rem;
            z-index: 10;
            border: var(--wrapper-border);
            color: var(--wrapper-text-color);
        }

        #game-wrapper h1 {
            color: var(--wrapper-h1-color);
        }

        #canvas-container {
            position: relative;
            background: var(--canvas-bg);
            border-radius: 1rem;
            border: var(--canvas-border);
            overflow: hidden;
            touch-action: none;
            min-height: 400px;
            box-shadow: var(--canvas-shadow);
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 400px;
            cursor: pointer;
        }

        .status-bar-item {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: var(--body-text-color); /* Use body text color for consistency */
            background-color: var(--status-item-bg);
            border: var(--status-item-border);
        }
        /* 特殊狀態欄顏色 */
        .status-bar-item#level-display-wrapper { background-color: var(--status-level-bg); border-color: var(--status-level-border); }
        .status-bar-item#level-display-wrapper span:first-child { color: var(--status-level-text); }
        .status-bar-item#timer-display-wrapper { background-color: var(--status-timer-bg); border-color: var(--status-timer-border); }
        .status-bar-item#timer-display-wrapper span:first-child { color: var(--status-timer-text); }
        .status-bar-item#score-display-wrapper { background-color: var(--status-score-bg); border-color: var(--status-score-border); }
        .status-bar-item#score-display-wrapper span:first-child { color: var(--status-score-text); }


        .game-button {
            padding: 0.6rem 2rem;
            background: var(--button-bg);
            color: var(--button-color);
            font-weight: 900;
            font-size: 1.1rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--button-hover-shadow);
        }

        /* 遊戲說明書樣式 */
        #instructions-modal {
            background-color: rgba(0, 0, 0, 0.85); /* 更深的半透明背景 */
            z-index: 50;
        }
        #instructions-modal .modal-content { /* 自定義 class 避免 Tailwind 衝突 */
            background-color: var(--modal-bg);
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: var(--modal-border);
            box-shadow: var(--modal-shadow);
        }
        #instructions-modal h2 {
            color: var(--modal-h2-color);
        }
        #instructions-modal h3 {
            color: var(--modal-h3-color);
        }
        #instructions-modal button.absolute {
            color: var(--modal-close-color);
        }
        #instructions-modal button.absolute:hover {
            color: var(--modal-hover-close-color);
        }


        /* 遊戲按鈕覆蓋層 */
        #game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 20;
            background: rgba(30,30,50,0.6); /* 輕微背景，讓文字更清晰 */
            border-radius: 1rem;
            transition: opacity 0.3s ease-in-out;
            opacity: 1;
        }

        #game-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        #game-overlay:not(.hidden) {
            display: flex;
        }

        #game-overlay > * {
            pointer-events: auto;
        }

        /* 主標題內的說明按鈕 */
        #title-instructions-button {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: var(--title-instructions-button-color);
            transition: color 0.2s;
        }
        #title-instructions-button:hover {
            color: var(--title-instructions-button-hover-color);
        }
        @media (min-width: 640px) {
            #title-instructions-button {
                right: 1rem;
            }
        }

        /* 物品小圖標在文字中的樣式 */
        .item-icon-inline {
            height: 1.5em;
            width: auto;
            vertical-align: middle;
            margin: 0 0.2em;
            display: inline-block;
        }
        /* 確保每個任務項目的圖片和文字不會斷開 */
        .mission-item-wrapper {
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
            margin-right: 1rem;
        }
        /* 任務目標區的文字 flex 容器 */
        #mission-display .flex-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 0;
        }

        #mission-display {
            background-color: var(--mission-bg);
            border-left: var(--mission-border);
            color: var(--mission-text-color);
        }
        #mission-display h2 {
            color: var(--mission-h2-color);
        }
        #mission-display .fa-camera-retro {
            color: var(--mission-target-icon-color);
        }
        #mission-display #targets {
            color: var(--mission-target-text-color);
        }
        #mission-display .fa-ban {
            color: var(--mission-forbidden-icon-color);
        }
        #mission-display #forbidden {
            color: var(--mission-forbidden-text-color);
        }
        #mission-display #level-name {
            color: var(--mission-level-name-color);
        }


        /* Feedback effects */
        .score-popup {
            position: absolute;
            font-size: 2rem;
            font-weight: bold;
            color: #fff; /* Base white, overridden by positive/negative */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            pointer-events: none;
            animation: fadeOutUp 1s forwards;
            z-index: 30;
        }

        @keyframes fadeOutUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(0.7); opacity: 0; }
        }

        .particle-effect {
            position: absolute;
            background-color: var(--particle-positive-color); /* Default to positive particle color */
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            animation: particle-burst 0.8s forwards;
            z-index: 30;
        }

        @keyframes particle-burst {
            0% { transform: scale(0) translate(0, 0); opacity: 1; }
            50% { transform: scale(1) translate(var(--dx), var(--dy)); opacity: 1; }
            100% { transform: scale(0) translate(var(--dx), var(--dy)); opacity: 0; }
        }

        .screen-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--screen-flash-color);
            opacity: 0;
            pointer-events: none;
            animation: flashRed 0.2s forwards;
            z-index: 40;
        }

        @keyframes flashRed {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Game Over buttons container style */
        #game-over-buttons {
            display: flex;
            flex-direction: column; /* Stack buttons vertically by default */
            gap: 1rem;
            margin-top: 1.5rem;
            align-items: center;
        }
        @media (min-width: 640px) { /* On larger screens, arrange horizontally */
            #game-over-buttons {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <h1 class="text-3xl font-extrabold mb-4 text-center relative">
            <!-- INSERT_GAME_TITLE_HERE -->
            <button id="title-instructions-button" onclick="toggleInstructions()">
                <i class="fas fa-info-circle text-2xl"></i>
            </button>
        </h1>

        <!-- 狀態欄：關卡、時間、分數 -->
        <div class="flex justify-between items-center mb-4 p-2 rounded-xl" style="background-color: var(--status-item-bg); border: var(--status-item-border);">
            <div id="level-display-wrapper" class="status-bar-item"><span class="">關卡:</span> <span id="level-display">0</span></div>
            <div id="timer-display-wrapper" class="status-bar-item text-2xl"><span class="">時間:</span> <span id="timer-display">0.0</span>s</div>
            <div id="score-display-wrapper" class="status-bar-item"><span class="">得分:</span> <span id="score-display">0</span></div>
        </div>

        <!-- 任務目標區 -->
        <div id="mission-display" class="mb-4 p-4 rounded-lg text-white">
            <h2 class="text-xl font-bold mb-2"><i class="fas fa-bullseye"></i> 任務目標:</h2>
            <div class="flex flex-wrap text-lg">
                <p><i class="fas fa-camera-retro"></i> 撈取: <span id="targets" class="font-bold">...</span></p>
                <p class="ml-4"><i class="fas fa-ban"></i> 避開: <span id="forbidden" class="font-bold">...</span></p>
            </div>
            <p id="level-name" class="text-sm mt-2 italic">遊戲尚未開始</p>
        </div>

        <!-- 畫布容器 -->
        <div id="canvas-container">
            <canvas id="gameCanvas"></canvas>
            <!-- 遊戲訊息與按鈕覆蓋層 -->
            <div id="game-overlay">
                <p id="game-message" class="text-lg text-white mb-4 text-center drop-shadow-lg"></p>
                <div id="game-over-buttons">
                    <button id="start-button" class="game-button"></button>
                    <!-- New buttons for game over states -->
                    <button id="restart-level-button" class="game-button hidden">重試本關</button>
                    <button id="back-to-first-level-button" class="game-button hidden">回到第一關</button>
                </div>
            </div>
            <!-- Feedback elements will be dynamically added here -->
        </div>

    </div>

    <!-- 版權資訊 -->
    <footer class="mt-8 text-center text-gray-400 text-sm py-4">
        <p><!-- INSERT_GENERATED_COPYRIGHT_HTML_HERE --></p>
    </footer>

    <!-- 遊戲說明書 Modal -->
    <div id="instructions-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content rounded-lg p-6 max-w-lg w-full text-white shadow-xl relative">
            <h2 class="text-2xl font-bold mb-4"><i class="fas fa-gamepad"></i> 遊戲說明</h2>
            <button class="absolute top-3 right-3 text-3xl font-bold" onclick="toggleInstructions()">&times;</button>

            <p class="mb-3">歡迎來到撈取挑戰！你的任務是在限時內，撈取到關卡指定的所有「目標」，同時「避開」所有禁忌物品。</p>

            <h3 class="text-xl font-bold mt-4 mb-2"><i class="fas fa-crosshairs"></i> 如何遊玩 (範例):</h3>
            <ul id="how-to-play-examples" class="list-disc list-inside mb-3 space-y-1">
                <!-- 這些範例將由 JavaScript 動態生成 -->
            </ul>
            <p class="text-sm italic text-gray-400 mb-3">請注意：每個關卡的目標與禁忌物品組合可能不同，以遊戲中顯示為準。</p>

            <h3 class="text-xl font-bold mt-4 mb-2"><i class="fas fa-star"></i> 遊戲提示:</h3>
            <ul class="list-disc list-inside space-y-1">
                <li>每個關卡的時間和目標都不同，請仔細查看。</li>
                <li>遊戲會隨著關卡推進而增加難度，物品移動速度會變快！</li>
                <li>精準判斷快照時機是獲勝的關鍵！</li>
                <li><strong class="text-red-400">誤觸禁忌物品會有懲罰，並可能暫時讓你無法操作！</strong></li>
            </ul>
            <button class="game-button mt-6 w-full" onclick="toggleInstructions()">我知道了！</button>
        </div>
    </div>
    <script>
        // --- 遊戲全局配置 ---
        /* <!-- INSERT_SCORE_PER_CAPTURE_HERE --> */
        /* <!-- INSERT_BONUS_ITEM_SCORE_HERE --> */
        /* <!-- INSERT_SCALE_FACTOR_HERE --> */
        /* <!-- INSERT_OBJECT_DEFINITIONS_HERE --> */
        /* <!-- INSERT_LEVELS_HERE --> */

        // Game state variables
        let canvas, ctx;
        let gameObjects = [];
        let score = 0;
        let scoreAtLevelStart = 0; // New: score at the beginning of the current level
        let timer = 0;
        let gameInterval; // Stores the requestAnimationFrame ID
        let currentLevelIndex = 0; // 0-based index
        let currentLevel;
        let gameRunning = false;
        let images = {}; // Store loaded images
        let lastTimestamp = 0; // For delta time calculation

        let stunned = false; // New: player is temporarily stunned
        let stunTimer = 0;   // New: duration of stun

        // Audio context for Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // DOM elements
        const levelDisplay = document.getElementById('level-display');
        const timerDisplay = document.getElementById('timer-display');
        const scoreDisplay = document.getElementById('score-display');
        const targetsDisplay = document.getElementById('targets');
        const forbiddenDisplay = document.getElementById('forbidden');
        const levelNameDisplay = document.getElementById('level-name');
        const gameOverlay = document.getElementById('game-overlay');
        const gameMessage = document.getElementById('game-message');
        const startButton = document.getElementById('start-button');
        const restartLevelButton = document.getElementById('restart-level-button'); // New
        const backToFirstLevelButton = document.getElementById('back-to-first-level-button'); // New
        const instructionsModal = document.getElementById('instructions-modal');
        const howToPlayExamples = document.getElementById('how-to-play-examples');
        const canvasContainer = document.getElementById('canvas-container'); // To add feedback elements

        // --- Audio Functions ---
        function playSound(frequency, duration, type, volume = 0.5) {
            if (!audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = type; // e.g., 'sine', 'square', 'sawtooth', 'triangle'
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime); // value in hertz

            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration); // Fade out

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playCollectSound() {
            playSound(880, 0.1, 'sine', 0.4); // High pitch for success
            setTimeout(() => playSound(1320, 0.1, 'sine', 0.4), 50); // Second, higher tone
        }

        function playPenaltySound() {
            playSound(200, 0.15, 'sawtooth', 0.6); // Low, harsh sound for penalty
            setTimeout(() => playSound(100, 0.15, 'sawtooth', 0.6), 75); // Even lower, more alarming
        }


        // --- Visual Feedback Functions ---
        function showScorePopup(x, y, scoreValue, isPositive) {
            const popup = document.createElement('div');
            popup.classList.add('score-popup');
            popup.textContent = (isPositive ? '+' : '-') + Math.abs(scoreValue);
            popup.style.color = isPositive ? 'var(--score-positive-color)' : 'var(--score-negative-color)';
            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;
            canvasContainer.appendChild(popup);

            // Adjust position for animation start (slightly above initial click)
            const initialTop = y - 10;
            popup.style.top = `${initialTop}px`;

            setTimeout(() => popup.remove(), 1000); // Remove after animation
        }

        function showParticleEffect(x, y, count = 10, color = 'var(--particle-positive-color)') { // Gold for capture
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle-effect');
                particle.style.backgroundColor = color;
                particle.style.width = `${Math.random() * 8 + 4}px`; // Random size
                particle.style.height = particle.style.width;
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;

                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 50 + 20;
                const dx = distance * Math.cos(angle);
                const dy = distance * Math.sin(angle);

                particle.style.setProperty('--dx', `${dx}px`);
                particle.style.setProperty('--dy', `${dy}px`);

                canvasContainer.appendChild(particle);
                setTimeout(() => particle.remove(), 800);
            }
        }

        function flashScreen(color = 'var(--screen-flash-color)', duration = 200) { // Red for penalty
            const flash = document.createElement('div');
            flash.classList.add('screen-flash');
            flash.style.animationDuration = `${duration}ms`; // Apply animation duration dynamically
            canvasContainer.appendChild(flash);
            setTimeout(() => flash.remove(), duration);
        }

        // --- Game Object Class (unchanged) ---
        class GameObject {
            constructor(definition, canvasWidth, canvasHeight) {
                this.key = definition.key; // e.g., REN_SHENG_SHAN_YAO
                this.name = definition.name;
                this.image = images[this.key];
                this.originalSize = definition.size / SCALE_FACTOR; // Store original base size (size in config is already scaled)
                this.scaledSize = definition.size; // Size after applying SCALE_FACTOR from config
                this.width = this.scaledSize;
                this.height = this.scaledSize;
                this.speed = definition.speed; // Base speed multiplier
                this.isBonus = definition.isBonus;
                this.type = 'normal'; // default, can be 'required' or 'forbidden' per level

                // Random initial position
                this.x = Math.random() * (canvasWidth - this.width);
                this.y = Math.random() * (canvasHeight - this.height);

                // Random initial direction (speedX, speedY)
                const angle = Math.random() * 2 * Math.PI;
                const baseSpeed = 0.5 * SCALE_FACTOR; // Adjust base speed for a more consistent feel
                this.speedX = baseSpeed * Math.cos(angle);
                this.speedY = baseSpeed * Math.sin(angle);
            }

            draw(ctx) {
                if (this.image && this.image.complete) {
                    ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
                } else {
                    // Fallback for missing image
                    ctx.fillStyle = '#FF00FF'; // Magenta
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    ctx.fillStyle = 'black';
                    ctx.fillText(this.name, this.x + 5, this.y + this.height / 2);
                }
            }

            update(deltaTime, canvasWidth, canvasHeight, levelSpeedMultiplier) {
                const effectiveSpeed = this.speed * levelSpeedMultiplier;
                // deltaTime / 16.67 (approx 1 frame at 60fps) ensures speed is frame-rate independent
                this.x += this.speedX * effectiveSpeed * (deltaTime / 16.67);
                this.y += this.speedY * effectiveSpeed * (deltaTime / 16.67);

                // Bounce off walls
                if (this.x < 0 || this.x + this.width > canvasWidth) {
                    this.speedX *= -1;
                    // Correct position to prevent sticking to edges
                    this.x = Math.max(0, Math.min(this.x, canvasWidth - this.width));
                }
                if (this.y < 0 || this.y + this.height > canvasHeight) {
                    this.speedY *= -1;
                    // Correct position to prevent sticking to edges
                    this.y = Math.max(0, Math.min(this.y, canvasHeight - this.height));
                }
            }

            // Check if point (px, py) is inside the object
            contains(px, py) {
                return px >= this.x && px <= this.x + this.width &&
                       py >= this.y && py <= this.y + this.height;
            }
        }

        // --- Game Initialization and Core Logic ---
        function initGame() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');

            // Set canvas dimensions based on container or fixed values
            canvas.width = canvasContainer.clientWidth;
            canvas.height = 400; // Fixed height, width is responsive

            // Add event listener once during initialization.
            // gameRunning flag will control if clicks are processed.
            canvas.addEventListener('pointerdown', handleCanvasClick);

            preloadImages().then(() => {
                console.log("All images preloaded.");
                resetGame(); // Reset game state (score, level index) and show initial overlay
                renderInstructions();
                updateUI(); // Ensure UI is updated after preload and reset
            }).catch(error => {
                console.error("Failed to preload images:", error);
                gameMessage.textContent = "圖片載入失敗，請檢查配置。";
                startButton.disabled = true;
            });
        }

        async function preloadImages() {
            const imagePromises = [];
            for (const key in ORIGINAL_IMAGE_DEFINITIONS) {
                if (ORIGINAL_IMAGE_DEFINITIONS.hasOwnProperty(key)) {
                    const imgDef = ORIGINAL_IMAGE_DEFINITIONS[key];
                    const img = new Image();
                    img.src = imgDef.path; // Path in the generated ZIP is item/itemNNN.ext
                    images[key] = img;

                    const promise = new Promise((resolve, reject) => {
                        img.onload = () => resolve();
                        img.onerror = () => {
                            console.warn(`Failed to load image: ${imgDef.path} for key ${key}. Using fallback.`);
                            // Fallback to a transparent GIF to prevent broken image icon
                            img.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; 
                            resolve(); // Resolve anyway to not block the game, but log a warning
                        };
                    });
                    imagePromises.push(promise);
                }
            }
            await Promise.all(imagePromises);
        }

        function resetGame() {
            score = 0;
            scoreAtLevelStart = 0; // Reset for a fresh start
            currentLevelIndex = 0; // Go back to the first level
            updateUI();
            stopGame(); // Stop any active game loop
            showInitialOverlay("點擊開始按鈕，開啟撈取挑戰！", "開始遊戲", () => startLevel(0));
        }

        function startLevel(levelIdx) {
            if (LEVELS.length === 0) {
                showInitialOverlay("沒有設定關卡，無法開始遊戲！", "重新設定", resetGame);
                return;
            }
            if (levelIdx >= LEVELS.length) {
                endGame(true); // All levels completed
                return;
            }

            currentLevelIndex = levelIdx; // Set the current level index
            scoreAtLevelStart = score; // Save current score before starting new level
            gameRunning = true;
            stunned = false; // Ensure player is not stunned at start of level
            gameOverlay.classList.add('hidden');
            loadLevel(currentLevelIndex);
            lastTimestamp = 0; // Reset lastTimestamp for accurate deltaTime
            gameLoop(0); // Start the game loop
        }

        function stopGame() {
            gameRunning = false;
            cancelAnimationFrame(gameInterval); // Stop the animation frame loop
            // Do NOT remove the event listener here, it stays active but gameRunning prevents processing
        }

        function loadLevel(levelIndex) {
            currentLevel = LEVELS[levelIndex];
            timer = currentLevel.duration; // Use the configured duration
            gameObjects = [];
            
            // Collect all possible object keys
            const allObjectKeys = Object.keys(ORIGINAL_IMAGE_DEFINITIONS);
            
            // Filter objects for required and forbidden only
            const availableObjectKeys = allObjectKeys.filter(key => 
                currentLevel.required.includes(key) || currentLevel.forbidden.includes(key)
            );

            if (availableObjectKeys.length === 0 && (currentLevel.required.length > 0 || currentLevel.forbidden.length > 0)) {
                alert(`關卡 "${currentLevel.name}" 沒有可用的目標或禁忌物品定義，請檢查物品配置！`);
                endGame(false); // Game cannot proceed if level config is invalid
                return;
            }

            for (let i = 0; i < currentLevel.objectCount; i++) {
                const randomKey = availableObjectKeys[Math.floor(Math.random() * availableObjectKeys.length)];
                const definition = { ...ORIGINAL_IMAGE_DEFINITIONS[randomKey], key: randomKey };
                const obj = new GameObject(definition, canvas.width, canvas.height); // Pass canvas dimensions
                
                // Assign type based on current level's requirements
                if (currentLevel.required.includes(randomKey)) {
                    obj.type = 'required';
                } else if (currentLevel.forbidden.includes(randomKey)) {
                    obj.type = 'forbidden';
                }
                gameObjects.push(obj);
            }
            updateUI();
        }

        function gameLoop(timestamp) {
            if (!gameRunning) return;

            // Initialize lastTimestamp on the first call to prevent large deltaTime
            if (lastTimestamp === 0) {
                lastTimestamp = timestamp;
            }

            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            update(deltaTime);
            draw();

            gameInterval = requestAnimationFrame(gameLoop);
        }

        function update(deltaTime) {
            // Update timer
            timer -= deltaTime / 1000; // Convert ms to seconds
            if (timer <= 0) {
                timer = 0;
                endGame(false); // Time's up
                return;
            }

            // Update stun timer if active
            if (stunned) {
                stunTimer -= deltaTime;
                if (stunTimer <= 0) {
                    stunned = false;
                    stunTimer = 0;
                }
            }

            // Update game objects
            gameObjects.forEach(obj => {
                obj.update(deltaTime, canvas.width, canvas.height, currentLevel.speedMultiplier);
            });

            updateUI();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas
            gameObjects.forEach(obj => obj.draw(ctx));
        }

        function handleCanvasClick(event) {
            if (!gameRunning || stunned) return; // Only process clicks if game is running and not stunned

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const clickX = (event.clientX - rect.left) * scaleX;
            const clickY = (event.clientY - rect.top) * scaleY;

            let capturedObject = null;
            let capturedObjectIndex = -1; // To remove from array
            // Iterate in reverse to capture topmost object
            for (let i = gameObjects.length - 1; i >= 0; i--) {
                if (gameObjects[i].contains(clickX, clickY)) {
                    capturedObject = gameObjects[i];
                    capturedObjectIndex = i;
                    break;
                }
            }

            if (capturedObject) {
                // Get click position relative to canvas container for popups
                const containerRect = canvasContainer.getBoundingClientRect();
                const popupX = event.clientX - containerRect.left;
                const popupY = event.clientY - containerRect.top;

                if (capturedObject.type === 'required') {
                    let points = SCORE_PER_CAPTURE;
                    if (capturedObject.isBonus) {
                        points += BONUS_ITEM_SCORE;
                    }
                    score += points;
                    playCollectSound();
                    showScorePopup(popupX, popupY, points, true);
                    showParticleEffect(capturedObject.x + capturedObject.width / 2, capturedObject.y + capturedObject.height / 2); // Center of object
                } else if (capturedObject.type === 'forbidden') {
                    const penalty = SCORE_PER_CAPTURE; // Use base score for penalty
                    score = Math.max(0, score - penalty); // Penalize, but not below zero
                    playPenaltySound();
                    flashScreen(); // Red screen flash
                    showScorePopup(popupX, popupY, penalty, false);
                    stunned = true; // Stun the player
                    stunTimer = 1000; // 1 second stun duration
                }
                
                gameObjects.splice(capturedObjectIndex, 1); // Remove object from game
                updateUI();
            }

            // Check for level completion
            const remainingRequired = gameObjects.filter(obj => obj.type === 'required').length;
            if (remainingRequired === 0) {
                stopGame(); // Stop current level game loop

                const completedLevelNumber = currentLevelIndex + 1; // 1-based number for display

                currentLevelIndex++; // Advance to the *next* level index

                if (currentLevelIndex < LEVELS.length) {
                    showLevelCompleteOverlay(`恭喜！關卡 ${completedLevelNumber} 完成！得分：${score} \n\n點擊進入下一關...`, () => startLevel(currentLevelIndex));
                } else {
                    endGame(true); // All levels completed
                }
            }
        }

        function endGame(allLevelsCompleted) {
            stopGame(); // Ensure game loop is stopped
            if (allLevelsCompleted) {
                showFinalScoreOverlay(`恭喜您！完成所有關卡！總得分：${score}`, "重新挑戰", resetGame);
            } else {
                showGameOverOverlay(`遊戲結束！您的得分：${score}`, 
                                    () => { 
                                        score = scoreAtLevelStart; // Revert score to start of level
                                        startLevel(currentLevelIndex); 
                                    }, 
                                    resetGame);
            }
        }

        // --- UI Update Functions ---
        function updateUI() {
            levelDisplay.textContent = currentLevelIndex + 1; // Display 1-based level number
            timerDisplay.textContent = timer.toFixed(1);
            scoreDisplay.textContent = score;

            if (currentLevel) {
                levelNameDisplay.textContent = currentLevel.name;

                const requiredNames = currentLevel.required.map(key => {
                    const objDef = ORIGINAL_IMAGE_DEFINITIONS[key];
                    if (objDef && images[key] && images[key].src) {
                        return `<span class="mission-item-wrapper"><img src="${images[key].src}" alt="${objDef.name}" class="item-icon-inline">${objDef.name}</span>`;
                    }
                    return `<span class="mission-item-wrapper">${objDef ? objDef.name : key}</span>`; // Fallback for definition or key
                }).join(', ');
                targetsDisplay.innerHTML = requiredNames || '無';

                const forbiddenNames = currentLevel.forbidden.map(key => {
                    const objDef = ORIGINAL_IMAGE_DEFINITIONS[key];
                    if (objDef && images[key] && images[key].src) {
                        return `<span class="mission-item-wrapper"><img src="${images[key].src}" alt="${objDef.name}" class="item-icon-inline">${objDef.name}</span>`;
                    }
                    return `<span class="mission-item-wrapper">${objDef ? objDef.name : key}</span>`; // Fallback
                }).join(', ');
                forbiddenDisplay.innerHTML = forbiddenNames || '無';

            } else {
                levelNameDisplay.textContent = "遊戲尚未開始";
                targetsDisplay.textContent = "...";
                forbiddenDisplay.textContent = "...";
            }
        }

        // Modified overlay functions to handle multiple buttons
        function hideAllOverlayButtons() {
            startButton.classList.add('hidden');
            restartLevelButton.classList.add('hidden');
            backToFirstLevelButton.classList.add('hidden');
        }

        function showInitialOverlay(message, buttonText, buttonAction) {
            gameMessage.innerHTML = message;
            hideAllOverlayButtons();
            startButton.textContent = buttonText;
            startButton.onclick = buttonAction;
            startButton.classList.remove('hidden');
            gameOverlay.classList.remove('hidden');
        }

        function showLevelCompleteOverlay(message, nextLevelAction) {
            gameMessage.innerHTML = message;
            hideAllOverlayButtons();
            startButton.textContent = "下一關";
            startButton.onclick = nextLevelAction;
            startButton.classList.remove('hidden');
            gameOverlay.classList.remove('hidden');
        }

        function showGameOverOverlay(message, retryCurrentLevelAction, backToFirstLevelAction) {
            gameMessage.innerHTML = message;
            hideAllOverlayButtons();
            restartLevelButton.onclick = retryCurrentLevelAction;
            backToFirstLevelButton.onclick = backToFirstLevelAction;
            restartLevelButton.classList.remove('hidden');
            backToFirstLevelButton.classList.remove('hidden');
            gameOverlay.classList.remove('hidden');
        }

        function showFinalScoreOverlay(message, restartGameAction) {
            gameMessage.innerHTML = message;
            hideAllOverlayButtons();
            startButton.textContent = "重新挑戰";
            startButton.onclick = restartGameAction;
            startButton.classList.remove('hidden');
            gameOverlay.classList.remove('hidden');
        }


        // --- Instructions Modal ---
        function toggleInstructions() {
            instructionsModal.classList.toggle('hidden');
        }

        function renderInstructions() {
            renderHowToPlayExamples(); // Call this once when images are loaded
        }

        function renderHowToPlayExamples() {
            howToPlayExamples.innerHTML = ''; // Clear existing examples

            if (LEVELS.length === 0) {
                howToPlayExamples.innerHTML = `<li>遊戲未設定任何關卡，無法提供範例。</li>`;
                return;
            }

            // Use the first level as an example for instructions
            const exampleLevel = LEVELS[0];
            const targetItems = exampleLevel.required;
            const forbiddenItems = exampleLevel.forbidden;

            // Example for required items
            if (targetItems.length > 0) {
                const targetExamplesHtml = targetItems.map(key => {
                    const objDef = ORIGINAL_IMAGE_DEFINITIONS[key];
                    if (objDef && images[key] && images[key].src) {
                        const bonusText = objDef.isBonus ? ` (獎勵物品)` : '';
                        return `<span class="mission-item-wrapper"><img src="${images[key].src}" alt="${objDef.name}" class="item-icon-inline">${objDef.name}</span>${bonusText}`;
                    }
                    return `<span class="mission-item-wrapper">${objDef ? objDef.name : key}</span>`;
                }).join(', ');
                howToPlayExamples.innerHTML += `<li>點擊或輕觸以下物品之一來成功撈取並得分：${targetExamplesHtml}</li>`;
            } else {
                howToPlayExamples.innerHTML += `<li>點擊或輕觸目標物品以成功撈取並得分。</li>`;
            }

            // Example for forbidden items
            if (forbiddenItems.length > 0) {
                const forbiddenExamplesHtml = forbiddenItems.map(key => {
                    const objDef = ORIGINAL_IMAGE_DEFINITIONS[key];
                    if (objDef && images[key] && images[key].src) {
                        return `<span class="mission-item-wrapper"><img src="${images[key].src}" alt="${objDef.name}" class="item-icon-inline">${objDef.name}</span>`;
                    }
                    return `<span class="mission-item-wrapper">${objDef ? objDef.name : key}</span>`;
                }).join(', ');
                howToPlayExamples.innerHTML += `<li>**請勿**點擊或輕觸以下物品，否則會扣分並可能導致暫時無法操作：${forbiddenExamplesHtml}</li>`;
            } else {
                howToPlayExamples.innerHTML += `<li>請勿點擊或輕觸禁忌物品，否則會扣分！</li>`;
            }
        }


        // --- Event Listeners and Initial Setup ---
        window.onload = initGame;

        // Ensure canvas resizes with window (if you want responsive width)
        window.addEventListener('resize', () => {
            if (canvas) {
                const currentWidth = canvas.width;
                canvas.width = canvasContainer.clientWidth;
                // If the width changed significantly, redraw
                if (Math.abs(currentWidth - canvas.width) > 5) { // Threshold of 5px
                    if (gameRunning) {
                        draw();
                    } else if (gameObjects.length > 0) {
                         // If game is paused/overlay, but objects are present, draw once
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        gameObjects.forEach(obj => obj.draw(ctx));
                    }
                }
            }
        });
    </script>
</body>
</html>
    </textarea>

    <!-- 引入 SortableJS (for dragging levels) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

    <!-- GENERATOR PAGE COPYRIGHT -->
    <div id="generator-copyright" class="text-center text-gray-500 text-sm mt-8 pb-4">
        Copyright © Liyuchiutiger Gongminshen
    </div>

    <script>
        // --- App Object: Encapsulates all logic ---
        const App = {
            CONFIG: {
                THEMES: {
                    '現代黑藍': {
                        '--body-bg': 'linear-gradient(135deg, #1a1a2e 0%, #2a003f 100%)',
                        '--body-text-color': '#e0e7ff',
                        '--wrapper-bg': 'rgba(30, 30, 50, 0.7)',
                        '--wrapper-border': '1px solid rgba(120, 80, 255, 0.4)',
                        '--wrapper-shadow': '0 10px 60px rgba(0, 0, 0, 0.5), 0 0 30px rgba(100, 50, 255, 0.3)',
                        '--wrapper-text-color': '#e0e7ff',
                        '--wrapper-h1-color': '#93c5fd', /* blue-300 */
                        '--canvas-bg': 'linear-gradient(180deg, #3a005f 0%, #5a007f 100%)',
                        '--canvas-border': '4px solid #00c4ff',
                        '--canvas-shadow': 'inset 0 0 15px rgba(0, 196, 255, 0.5)',
                        '--status-item-bg': 'rgba(255, 255, 255, 0.1)',
                        '--status-item-border': '1px solid rgba(255, 255, 255, 0.2)',
                        '--status-level-bg': 'rgba(100, 255, 200, 0.1)',
                        '--status-level-border': 'rgba(100, 255, 200, 0.3)',
                        '--status-timer-bg': 'rgba(255, 100, 150, 0.1)',
                        '--status-timer-border': 'rgba(255, 100, 150, 0.3)',
                        '--status-score-bg': 'rgba(100, 150, 255, 0.1)',
                        '--status-score-border': 'rgba(100, 150, 255, 0.3)',
                        '--status-level-text': '#6ee7b7', /* green-300 */
                        '--status-timer-text': '#fbcfe8', /* pink-300 */
                        '--status-score-text': '#93c5fd', /* blue-300 */
                        '--mission-bg': 'rgba(128, 0, 128, 0.4)', /* purple-900/40 */
                        '--mission-border': '4px solid #60a5fa', /* blue-400 */
                        '--mission-text-color': '#fff',
                        '--mission-h2-color': '#93c5fd',
                        '--mission-target-icon-color': '#6ee7b7',
                        '--mission-target-text-color': '#6ee7b7',
                        '--mission-forbidden-icon-color': '#fca5a5',
                        '--mission-forbidden-text-color': '#fca5a5',
                        '--mission-level-name-color': '#d1d5db', /* gray-300 */
                        '--button-bg': 'linear-gradient(145deg, #8a2be2, #c080ff)',
                        '--button-color': '#ffffff',
                        '--button-shadow': '0 4px 15px rgba(138, 43, 226, 0.5), 0 0 20px rgba(192, 128, 255, 0.7)',
                        '--button-hover-shadow': '0 6px 20px rgba(138, 43, 226, 0.8), 0 0 30px rgba(192, 128, 255, 0.9)',
                        '--modal-bg': '#2c004a',
                        '--modal-border': '1px solid rgba(192, 128, 255, 0.4)',
                        '--modal-shadow': '0 0 40px rgba(138, 43, 226, 0.6)',
                        '--modal-h2-color': '#93c5fd',
                        '--modal-h3-color': '#6ee7b7',
                        '--modal-close-color': '#9ca3af',
                        '--modal-hover-close-color': '#fff',
                        '--title-instructions-button-color': '#00c4ff',
                        '--title-instructions-button-hover-color': '#8a2be2',
                        '--score-positive-color': '#90EE90',
                        '--score-negative-color': '#FF6347',
                        '--particle-positive-color': '#FFD700',
                        '--screen-flash-color': 'rgba(255, 0, 0, 0.4)'
                    },
                    '經典木質': {
                        '--body-bg': 'linear-gradient(135deg, #a88460 0%, #7c5a3d 100%)',
                        '--body-text-color': '#3e2e21',
                        '--wrapper-bg': 'rgba(100, 75, 50, 0.8)',
                        '--wrapper-border': '1px solid rgba(150, 120, 90, 0.6)',
                        '--wrapper-shadow': '0 8px 30px rgba(0, 0, 0, 0.4), 0 0 15px rgba(150, 120, 90, 0.2)',
                        '--wrapper-text-color': '#f5deb3',
                        '--wrapper-h1-color': '#f0e68c', /* Khaki */
                        '--canvas-bg': 'linear-gradient(180deg, #5b876e 0%, #4b6a5a 100%)',
                        '--canvas-border': '4px solid #8B4513', /* SaddleBrown */
                        '--canvas-shadow': 'inset 0 0 10px rgba(139, 69, 19, 0.4)',
                        '--status-item-bg': 'rgba(255, 255, 255, 0.15)',
                        '--status-item-border': '1px solid rgba(255, 255, 255, 0.25)',
                        '--status-level-bg': 'rgba(173, 216, 230, 0.15)', /* LightBlue */
                        '--status-level-border': 'rgba(173, 216, 230, 0.3)',
                        '--status-timer-bg': 'rgba(255, 165, 0, 0.15)', /* Orange */
                        '--status-timer-border': 'rgba(255, 165, 0, 0.3)',
                        '--status-score-bg': 'rgba(152, 251, 152, 0.15)', /* PaleGreen */
                        '--status-score-border': 'rgba(152, 251, 152, 0.3)',
                        '--status-level-text': '#b0e0e6', /* PowderBlue */
                        '--status-timer-text': '#ffcc80', /* Light Orange */
                        '--status-score-text': '#98fb98', /* PaleGreen */
                        '--mission-bg': 'rgba(80, 50, 30, 0.7)',
                        '--mission-border': '4px solid #d2b48c', /* Tan */
                        '--mission-text-color': '#fdf5e6', /* OldLace */
                        '--mission-h2-color': '#f0e68c',
                        '--mission-target-icon-color': '#90ee90',
                        '--mission-target-text-color': '#90ee90',
                        '--mission-forbidden-icon-color': '#ff6347',
                        '--mission-forbidden-text-color': '#ff6347',
                        '--mission-level-name-color': '#deb887', /* BurlyWood */
                        '--button-bg': 'linear-gradient(145deg, #d2b48c, #a08060)', /* Tan to darker */
                        '--button-color': '#3e2e21',
                        '--button-shadow': '0 4px 15px rgba(0, 0, 0, 0.3), 0 0 10px rgba(210, 180, 140, 0.5)',
                        '--button-hover-shadow': '0 6px 20px rgba(0, 0, 0, 0.4), 0 0 15px rgba(210, 180, 140, 0.7)',
                        '--modal-bg': '#7a523a',
                        '--modal-border': '1px solid rgba(210, 180, 140, 0.6)',
                        '--modal-shadow': '0 0 25px rgba(80, 50, 30, 0.7)',
                        '--modal-h2-color': '#f0e68c',
                        '--modal-h3-color': '#90ee90',
                        '--modal-close-color': '#fdf5e6',
                        '--modal-hover-close-color': '#fff',
                        '--title-instructions-button-color': '#f0e68c',
                        '--title-instructions-button-hover-color': '#d2b48c',
                        '--score-positive-color': '#90ee90',
                        '--score-negative-color': '#ff6347',
                        '--particle-positive-color': '#deb887', /* BurlyWood */
                        '--screen-flash-color': 'rgba(255, 0, 0, 0.4)'
                    },
                    '明亮橙黃': {
                        '--body-bg': 'linear-gradient(135deg, #fceabb 0%, #f8b500 100%)',
                        '--body-text-color': '#333333',
                        '--wrapper-bg': 'rgba(255, 255, 255, 0.9)',
                        '--wrapper-border': '1px solid rgba(255, 165, 0, 0.6)',
                        '--wrapper-shadow': '0 10px 40px rgba(0, 0, 0, 0.2), 0 0 20px rgba(255, 165, 0, 0.4)',
                        '--wrapper-text-color': '#333333',
                        '--wrapper-h1-color': '#ff8c00', /* DarkOrange */
                        '--canvas-bg': 'linear-gradient(180deg, #ffd700 0%, #ffa500 100%)',
                        '--canvas-border': '4px solid #ff4500', /* OrangeRed */
                        '--canvas-shadow': 'inset 0 0 12px rgba(255, 69, 0, 0.5)',
                        '--status-item-bg': 'rgba(0, 0, 0, 0.05)',
                        '--status-item-border': '1px solid rgba(0, 0, 0, 0.1)',
                        '--status-level-bg': 'rgba(144, 238, 144, 0.15)', /* LightGreen */
                        '--status-level-border': 'rgba(144, 238, 144, 0.3)',
                        '--status-timer-bg': 'rgba(255, 99, 71, 0.15)', /* Tomato */
                        '--status-timer-border': 'rgba(255, 99, 71, 0.3)',
                        '--status-score-bg': 'rgba(30, 144, 255, 0.15)', /* DodgerBlue */
                        '--status-score-border': 'rgba(30, 144, 255, 0.3)',
                        '--status-level-text': '#66bb66', /* light green */
                        '--status-timer-text': '#ff7f50', /* coral */
                        '--status-score-text': '#6495ed', /* cornflowerblue */
                        '--mission-bg': 'rgba(255, 140, 0, 0.4)', /* DarkOrange */
                        '--mission-border': '4px solid #ffdab9', /* PeachPuff */
                        '--mission-text-color': '#333333',
                        '--mission-h2-color': '#ff8c00',
                        '--mission-target-icon-color': '#008000',
                        '--mission-target-text-color': '#008000',
                        '--mission-forbidden-icon-color': '#b22222',
                        '--mission-forbidden-text-color': '#b22222',
                        '--mission-level-name-color': '#696969', /* DimGray */
                        '--button-bg': 'linear-gradient(145deg, #ff8c00, #ffa500)', /* DarkOrange to Orange */
                        '--button-color': '#ffffff',
                        '--button-shadow': '0 4px 15px rgba(255, 140, 0, 0.5), 0 0 20px rgba(255, 165, 0, 0.7)',
                        '--button-hover-shadow': '0 6px 20px rgba(255, 140, 0, 0.8), 0 0 30px rgba(255, 165, 0, 0.9)',
                        '--modal-bg': '#ffbf00', /* Amber */
                        '--modal-border': '1px solid rgba(255, 165, 0, 0.6)',
                        '--modal-shadow': '0 0 30px rgba(255, 140, 0, 0.6)',
                        '--modal-h2-color': '#b8860b', /* DarkGoldenrod */
                        '--modal-h3-color': '#32cd32', /* LimeGreen */
                        '--modal-close-color': '#696969',
                        '--modal-hover-close-color': '#333333',
                        '--title-instructions-button-color': '#ff4500',
                        '--title-instructions-button-hover-color': '#ff8c00',
                        '--score-positive-color': '#008000', /* Green */
                        '--score-negative-color': '#b22222', /* FireBrick */
                        '--particle-positive-color': '#ffd700', /* Gold */
                        '--screen-flash-color': 'rgba(255, 0, 0, 0.4)'
                    },
                    '賽博龐克': {
                        '--body-bg': 'linear-gradient(135deg, #0f0f0f 0%, #1e0f2e 100%)',
                        '--body-text-color': '#00ffc4', /* Neon Green */
                        '--wrapper-bg': 'rgba(20, 20, 30, 0.9)',
                        '--wrapper-border': '1px solid rgba(0, 255, 196, 0.5)',
                        '--wrapper-shadow': '0 10px 60px rgba(0, 255, 196, 0.3), 0 0 30px rgba(128, 0, 255, 0.4)',
                        '--wrapper-text-color': '#00ffc4',
                        '--wrapper-h1-color': '#ff00ff', /* Magenta */
                        '--canvas-bg': 'repeating-linear-gradient(45deg, #1a002a 0%, #1a002a 10px, #2a003f 10px, #2a003f 20px)',
                        '--canvas-border': '4px solid #00ffc4',
                        '--canvas-shadow': 'inset 0 0 15px rgba(0, 255, 196, 0.7)',
                        '--status-item-bg': 'rgba(0, 255, 196, 0.1)',
                        '--status-item-border': '1px solid rgba(0, 255, 196, 0.2)',
                        '--status-level-bg': 'rgba(0, 255, 255, 0.15)', /* Cyan */
                        '--status-level-border': 'rgba(0, 255, 255, 0.3)',
                        '--status-timer-bg': 'rgba(255, 0, 255, 0.15)', /* Magenta */
                        '--status-timer-border': 'rgba(255, 0, 255, 0.3)',
                        '--status-score-bg': 'rgba(255, 255, 0, 0.15)', /* Yellow */
                        '--status-score-border': 'rgba(255, 255, 0, 0.3)',
                        '--status-level-text': '#00ffff',
                        '--status-timer-text': '#ff00ff',
                        '--status-score-text': '#ffff00',
                        '--mission-bg': 'rgba(128, 0, 128, 0.6)', /* dark purple */
                        '--mission-border': '4px solid #ff00ff', /* Magenta */
                        '--mission-text-color': '#00ffc4',
                        '--mission-h2-color': '#ff00ff',
                        '--mission-target-icon-color': '#00ffff',
                        '--mission-target-text-color': '#00ffff',
                        '--mission-forbidden-icon-color': '#ff00ff',
                        '--mission-forbidden-text-color': '#ff00ff',
                        '--mission-level-name-color': '#aaffaa',
                        '--button-bg': 'linear-gradient(145deg, #ff00ff, #00ffff)', /* Magenta to Cyan */
                        '--button-color': '#0f0f0f',
                        '--button-shadow': '0 4px 15px rgba(255, 0, 255, 0.5), 0 0 20px rgba(0, 255, 255, 0.7)',
                        '--button-hover-shadow': '0 6px 20px rgba(255, 0, 255, 0.8), 0 0 30px rgba(0, 255, 255, 0.9)',
                        '--modal-bg': '#1a002a',
                        '--modal-border': '1px solid rgba(0, 255, 196, 0.5)',
                        '--modal-shadow': '0 0 40px rgba(128, 0, 255, 0.6)',
                        '--modal-h2-color': '#ff00ff',
                        '--modal-h3-color': '#00ffff',
                        '--modal-close-color': '#00ffc4',
                        '--modal-hover-close-color': '#ffff00',
                        '--title-instructions-button-color': '#00ffc4',
                        '--title-instructions-button-hover-color': '#ff00ff',
                        '--score-positive-color': '#00ff00', /* Green */
                        '--score-negative-color': '#ff0000', /* Red */
                        '--particle-positive-color': '#ffff00', /* Yellow */
                        '--screen-flash-color': 'rgba(255, 0, 0, 0.6)'
                    },
                    '田園森林': {
                        '--body-bg': 'linear-gradient(135deg, #e0ffe0 0%, #c8f0c8 100%)',
                        '--body-text-color': '#336633',
                        '--wrapper-bg': 'rgba(240, 255, 240, 0.8)',
                        '--wrapper-border': '1px solid rgba(100, 150, 100, 0.5)',
                        '--wrapper-shadow': '0 8px 30px rgba(0, 0, 0, 0.2), 0 0 15px rgba(100, 150, 100, 0.3)',
                        '--wrapper-text-color': '#336633',
                        '--wrapper-h1-color': '#228b22', /* ForestGreen */
                        '--canvas-bg': 'linear-gradient(180deg, #5c8d64 0%, #3e6d42 100%)',
                        '--canvas-border': '4px solid #8b4513', /* SaddleBrown */
                        '--canvas-shadow': 'inset 0 0 10px rgba(60, 80, 60, 0.5)',
                        '--status-item-bg': 'rgba(255, 255, 255, 0.2)',
                        '--status-item-border': '1px solid rgba(255, 255, 255, 0.3)',
                        '--status-level-bg': 'rgba(173, 216, 230, 0.2)', /* LightBlue */
                        '--status-level-border': 'rgba(173, 216, 230, 0.4)',
                        '--status-timer-bg': 'rgba(255, 99, 71, 0.2)', /* Tomato */
                        '--status-timer-border': 'rgba(255, 99, 71, 0.4)',
                        '--status-score-bg': 'rgba(255, 215, 0, 0.2)', /* Gold */
                        '--status-score-border': 'rgba(255, 215, 0, 0.4)',
                        '--status-level-text': '#66cdaa', /* MediumAquamarine */
                        '--status-timer-text': '#ffb6c1', /* LightPink */
                        '--status-score-text': '#ffd700', /* Gold */
                        '--mission-bg': 'rgba(60, 90, 60, 0.7)',
                        '--mission-border': '4px solid #a0522d', /* Sienna */
                        '--mission-text-color': '#e0ffe0',
                        '--mission-h2-color': '#98fb98', /* PaleGreen */
                        '--mission-target-icon-color': '#7cfc00', /* LawnGreen */
                        '--mission-target-text-color': '#7cfc00',
                        '--mission-forbidden-icon-color': '#cc0000',
                        '--mission-forbidden-text-color': '#cc0000',
                        '--mission-level-name-color': '#a9a9a9', /* DarkGray */
                        '--button-bg': 'linear-gradient(145deg, #3cb371, #6b8e23)', /* MediumSeaGreen to OliveDrab */
                        '--button-color': '#ffffff',
                        '--button-shadow': '0 4px 15px rgba(60, 179, 113, 0.5), 0 0 20px rgba(107, 142, 35, 0.7)',
                        '--button-hover-shadow': '0 6px 20px rgba(60, 179, 113, 0.8), 0 0 30px rgba(107, 142, 35, 0.9)',
                        '--modal-bg': '#4f7942', /* DarkMossGreen */
                        '--modal-border': '1px solid rgba(150, 200, 150, 0.5)',
                        '--modal-shadow': '0 0 30px rgba(60, 90, 60, 0.7)',
                        '--modal-h2-color': '#90ee90',
                        '--modal-h3-color': '#f0e68c',
                        '--modal-close-color': '#e0ffe0',
                        '--modal-hover-close-color': '#ffffff',
                        '--title-instructions-button-color': '#228b22',
                        '--title-instructions-button-hover-color': '#3cb371',
                        '--score-positive-color': '#008000', /* Green */
                        '--score-negative-color': '#b22222', /* FireBrick */
                        '--particle-positive-color': '#add8e6', /* LightBlue */
                        '--screen-flash-color': 'rgba(255, 0, 0, 0.4)'
                    },
                    '彩虹漸層': {
                        '--body-bg': 'linear-gradient(135deg, #ff7e5f, #feb47b, #84fab0, #8fd3f4)',
                        '--body-text-color': '#333333',
                        '--wrapper-bg': 'rgba(255, 255, 255, 0.9)',
                        '--wrapper-border': '1px solid rgba(128, 0, 128, 0.3)', /* Purple */
                        '--wrapper-shadow': '0 10px 40px rgba(0, 0, 0, 0.2), 0 0 20px rgba(255, 100, 200, 0.4)',
                        '--wrapper-text-color': '#333333',
                        '--wrapper-h1-color': '#8e2de2', /* Darker Purple */
                        '--canvas-bg': 'linear-gradient(180deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3)', /* Full Rainbow */
                        '--canvas-border': '4px solid #ff1493', /* DeepPink */
                        '--canvas-shadow': 'inset 0 0 15px rgba(255, 20, 147, 0.7)',
                        '--status-item-bg': 'rgba(0, 0, 0, 0.05)',
                        '--status-item-border': '1px solid rgba(0, 0, 0, 0.1)',
                        '--status-level-bg': 'rgba(255, 192, 203, 0.2)', /* Pink */
                        '--status-level-border': 'rgba(255, 192, 203, 0.4)',
                        '--status-timer-bg': 'rgba(173, 216, 230, 0.2)', /* LightBlue */
                        '--status-timer-border': 'rgba(173, 216, 230, 0.4)',
                        '--status-score-bg': 'rgba(144, 238, 144, 0.2)', /* LightGreen */
                        '--status-score-border': 'rgba(144, 238, 144, 0.4)',
                        '--status-level-text': '#ff69b4', /* HotPink */
                        '--status-timer-text': '#87cefa', /* LightSkyBlue */
                        '--status-score-text': '#32cd32', /* LimeGreen */
                        '--mission-bg': 'rgba(128, 0, 128, 0.4)',
                        '--mission-border': '4px solid #ff69b4', /* HotPink */
                        '--mission-text-color': '#333333',
                        '--mission-h2-color': '#8e2de2',
                        '--mission-target-icon-color': '#008000',
                        '--mission-target-text-color': '#008000',
                        '--mission-forbidden-icon-color': '#b22222',
                        '--mission-forbidden-text-color': '#b22222',
                        '--mission-level-name-color': '#696969',
                        '--button-bg': 'linear-gradient(145deg, #ff1493, #8a2be2)', /* DeepPink to BlueViolet */
                        '--button-color': '#ffffff',
                        '--button-shadow': '0 4px 15px rgba(255, 20, 147, 0.5), 0 0 20px rgba(138, 43, 226, 0.7)',
                        '--button-hover-shadow': '0 6px 20px rgba(255, 20, 147, 0.8), 0 0 30px rgba(138, 43, 226, 0.9)',
                        '--modal-bg': '#f08080', /* LightCoral */
                        '--modal-border': '1px solid rgba(255, 100, 200, 0.6)',
                        '--modal-shadow': '0 0 30px rgba(255, 20, 147, 0.6)',
                        '--modal-h2-color': '#8a2be2',
                        '--modal-h3-color': '#32cd32',
                        '--modal-close-color': '#ffffff',
                        '--modal-hover-close-color': '#000000',
                        '--title-instructions-button-color': '#ff69b4',
                        '--title-instructions-button-hover-color': '#ff1493',
                        '--score-positive-color': '#008000',
                        '--score-negative-color': '#b22222',
                        '--particle-positive-color': '#ff0000', /* Red */
                        '--screen-flash-color': 'rgba(255, 0, 0, 0.4)'
                    },
                    '粉紅泡泡': {
                        '--body-bg': 'linear-gradient(135deg, #ffe4e1 0%, #ffc0cb 100%)',
                        '--body-text-color': '#8b008b', /* DarkMagenta */
                        '--wrapper-bg': 'rgba(255, 240, 245, 0.9)', /* LavenderBlush */
                        '--wrapper-border': '1px solid rgba(255, 192, 203, 0.6)',
                        '--wrapper-shadow': '0 10px 40px rgba(255, 192, 203, 0.3), 0 0 20px rgba(255, 192, 203, 0.5)',
                        '--wrapper-text-color': '#8b008b',
                        '--wrapper-h1-color': '#ff69b4', /* HotPink */
                        '--canvas-bg': 'linear-gradient(180deg, #ffc0cb 0%, #e0b0ff 100%)', /* Pink to Thistle */
                        '--canvas-border': '4px solid #da70d6', /* Orchid */
                        '--canvas-shadow': 'inset 0 0 15px rgba(218, 112, 214, 0.7)',
                        '--status-item-bg': 'rgba(255, 255, 255, 0.1)',
                        '--status-item-border': '1px solid rgba(255, 255, 255, 0.2)',
                        '--status-level-bg': 'rgba(173, 216, 230, 0.2)', /* LightBlue */
                        '--status-level-border': 'rgba(173, 216, 230, 0.4)',
                        '--status-timer-bg': 'rgba(255, 99, 71, 0.2)', /* Tomato */
                        '--status-timer-border': 'rgba(255, 99, 71, 0.4)',
                        '--status-score-bg': 'rgba(144, 238, 144, 0.2)', /* LightGreen */
                        '--status-score-border': 'rgba(144, 238, 144, 0.4)',
                        '--status-level-text': '#ffb6c1', /* LightPink */
                        '--status-timer-text': '#dda0dd', /* Plum */
                        '--status-score-text': '#9370db', /* MediumPurple */
                        '--mission-bg': 'rgba(255, 105, 180, 0.5)', /* HotPink */
                        '--mission-border': '4px solid #e6e6fa', /* Lavender */
                        '--mission-text-color': '#8b008b',
                        '--mission-h2-color': '#ff69b4',
                        '--mission-target-icon-color': '#ba55d3', /* MediumOrchid */
                        '--mission-target-text-color': '#ba55d3',
                        '--mission-forbidden-icon-color': '#dc143c', /* Crimson */
                        '--mission-forbidden-text-color': '#dc143c',
                        '--mission-level-name-color': '#c0c0c0', /* Silver */
                        '--button-bg': 'linear-gradient(145deg, #ff69b4, #da70d6)', /* HotPink to Orchid */
                        '--button-color': '#ffffff',
                        '--button-shadow': '0 4px 15px rgba(255, 105, 180, 0.5), 0 0 20px rgba(218, 112, 214, 0.7)',
                        '--button-hover-shadow': '0 6px 20px rgba(255, 105, 180, 0.8), 0 0 30px rgba(218, 112, 214, 0.9)',
                        '--modal-bg': '#ffb6c1', /* LightPink */
                        '--modal-border': '1px solid rgba(255, 192, 203, 0.6)',
                        '--modal-shadow': '0 0 30px rgba(255, 105, 180, 0.6)',
                        '--modal-h2-color': '#8b008b',
                        '--modal-h3-color': '#ba55d3',
                        '--modal-close-color': '#8b008b',
                        '--modal-hover-close-color': '#ffffff',
                        '--title-instructions-button-color': '#ff69b4',
                        '--title-instructions-button-hover-color': '#da70d6',
                        '--score-positive-color': '#8a2be2', /* BlueViolet */
                        '--score-negative-color': '#dc143c', /* Crimson */
                        '--particle-positive-color': '#ffebcd', /* BlanchedAlmond */
                        '--screen-flash-color': 'rgba(255, 0, 0, 0.4)'
                    },
                    '海洋之心': {
                        '--body-bg': 'linear-gradient(135deg, #001f3f 0%, #0074d9 100%)',
                        '--body-text-color': '#e0f2f7',
                        '--wrapper-bg': 'rgba(0, 50, 100, 0.7)',
                        '--wrapper-border': '1px solid rgba(173, 216, 230, 0.5)', /* LightBlue */
                        '--wrapper-shadow': '0 10px 60px rgba(0, 0, 0, 0.4), 0 0 30px rgba(0, 191, 255, 0.3)', /* DeepSkyBlue */
                        '--wrapper-text-color': '#e0f2f7',
                        '--wrapper-h1-color': '#87ceeb', /* SkyBlue */
                        '--canvas-bg': 'linear-gradient(180deg, #00bfff 0%, #1e90ff 100%)', /* DeepSkyBlue to DodgerBlue */
                        '--canvas-border': '4px solid #4682b4', /* SteelBlue */
                        '--canvas-shadow': 'inset 0 0 15px rgba(70, 130, 180, 0.7)',
                        '--status-item-bg': 'rgba(255, 255, 255, 0.15)',
                        '--status-item-border': '1px solid rgba(255, 255, 255, 0.25)',
                        '--status-level-bg': 'rgba(144, 238, 144, 0.15)', /* LightGreen */
                        '--status-level-border': 'rgba(144, 238, 144, 0.3)',
                        '--status-timer-bg': 'rgba(255, 99, 71, 0.15)', /* Tomato */
                        '--status-timer-border': 'rgba(255, 99, 71, 0.3)',
                        '--status-score-bg': 'rgba(255, 215, 0, 0.15)', /* Gold */
                        '--status-score-border': 'rgba(255, 215, 0, 0.3)',
                        '--status-level-text': '#7fffd4', /* Aquamarine */
                        '--status-timer-text': '#ffb6c1', /* LightPink */
                        '--status-score-text': '#ffd700', /* Gold */
                        '--mission-bg': 'rgba(0, 70, 140, 0.6)',
                        '--mission-border': '4px solid #b0e0e6', /* PowderBlue */
                        '--mission-text-color': '#e0f2f7',
                        '--mission-h2-color': '#87ceeb',
                        '--mission-target-icon-color': '#40e0d0', /* Turquoise */
                        '--mission-target-text-color': '#40e0d0',
                        '--mission-forbidden-icon-color': '#dc143c', /* Crimson */
                        '--mission-forbidden-text-color': '#dc143c',
                        '--mission-level-name-color': '#a9d9e5', /* light blue-gray */
                        '--button-bg': 'linear-gradient(145deg, #1e90ff, #00bfff)', /* DodgerBlue to DeepSkyBlue */
                        '--button-color': '#ffffff',
                        '--button-shadow': '0 4px 15px rgba(30, 144, 255, 0.5), 0 0 20px rgba(0, 191, 255, 0.7)',
                        '--button-hover-shadow': '0 6px 20px rgba(30, 144, 255, 0.8), 0 0 30px rgba(0, 191, 255, 0.9)',
                        '--modal-bg': '#003366', /* DarkBlue */
                        '--modal-border': '1px solid rgba(173, 216, 230, 0.6)',
                        '--modal-shadow': '0 0 40px rgba(0, 191, 255, 0.5)',
                        '--modal-h2-color': '#87ceeb',
                        '--modal-h3-color': '#40e0d0',
                        '--modal-close-color': '#e0f2f7',
                        '--modal-hover-close-color': '#ffffff',
                        '--title-instructions-button-color': '#4682b4',
                        '--title-instructions-button-hover-color': '#1e90ff',
                        '--score-positive-color': '#7fffd4', /* Aquamarine */
                        '--score-negative-color': '#dc143c', /* Crimson */
                        '--particle-positive-color': '#ffffff',
                        '--screen-flash-color': 'rgba(255, 0, 0, 0.4)'
                    },
                    '搖滾黑白': {
                        '--body-bg': 'linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%)',
                        '--body-text-color': '#e0e0e0',
                        '--wrapper-bg': 'rgba(25, 25, 25, 0.9)',
                        '--wrapper-border': '1px solid rgba(150, 150, 150, 0.3)',
                        '--wrapper-shadow': '0 10px 40px rgba(0, 0, 0, 0.6), 0 0 20px rgba(100, 100, 100, 0.3)',
                        '--wrapper-text-color': '#e0e0e0',
                        '--wrapper-h1-color': '#ffffff',
                        '--canvas-bg': 'linear-gradient(180deg, #333333 0%, #111111 100%)',
                        '--canvas-border': '4px solid #808080', /* Gray */
                        '--canvas-shadow': 'inset 0 0 15px rgba(128, 128, 128, 0.5)',
                        '--status-item-bg': 'rgba(255, 255, 255, 0.1)',
                        '--status-item-border': '1px solid rgba(255, 255, 255, 0.2)',
                        '--status-level-bg': 'rgba(0, 255, 0, 0.1)', /* Green */
                        '--status-level-border': 'rgba(0, 255, 0, 0.2)',
                        '--status-timer-bg': 'rgba(255, 0, 0, 0.1)', /* Red */
                        '--status-timer-border': 'rgba(255, 0, 0, 0.2)',
                        '--status-score-bg': 'rgba(0, 0, 255, 0.1)', /* Blue */
                        '--status-score-border': 'rgba(0, 0, 255, 0.2)',
                        '--status-level-text': '#00ff00',
                        '--status-timer-text': '#ff0000',
                        '--status-score-text': '#0000ff',
                        '--mission-bg': 'rgba(50, 50, 50, 0.7)',
                        '--mission-border': '4px solid #a0a0a0', /* LightGray */
                        '--mission-text-color': '#e0e0e0',
                        '--mission-h2-color': '#ffffff',
                        '--mission-target-icon-color': '#00ff00',
                        '--mission-target-text-color': '#00ff00',
                        '--mission-forbidden-icon-color': '#ff0000',
                        '--mission-forbidden-text-color': '#ff0000',
                        '--mission-level-name-color': '#a0a0a0',
                        '--button-bg': 'linear-gradient(145deg, #666666, #333333)',
                        '--button-color': '#ffffff',
                        '--button-shadow': '0 4px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(100, 100, 100, 0.6)',
                        '--button-hover-shadow': '0 6px 20px rgba(0, 0, 0, 0.5), 0 0 30px rgba(100, 100, 100, 0.8)',
                        '--modal-bg': '#222222',
                        '--modal-border': '1px solid rgba(150, 150, 150, 0.4)',
                        '--modal-shadow': '0 0 30px rgba(0, 0, 0, 0.7)',
                        '--modal-h2-color': '#ffffff',
                        '--modal-h3-color': '#00ff00',
                        '--modal-close-color': '#e0e0e0',
                        '--modal-hover-close-color': '#ffffff',
                        '--title-instructions-button-color': '#808080',
                        '--title-instructions-button-hover-color': '#ffffff',
                        '--score-positive-color': '#00ff00',
                        '--score-negative-color': '#ff0000',
                        '--particle-positive-color': '#ffffff',
                        '--screen-flash-color': 'rgba(255, 0, 0, 0.4)'
                    },
                }
            },
            cache: {},
            state: {
                objects: [],
                levels: [],
                objectIdCounter: 0,
                _nextSequentialItemNumberForDisplay: 1,
                generatedGameConfig: null, // 儲存生成的最終配置
                selectedTheme: '現代黑藍' // Default theme
            },

            init() {
                this.cacheElements();
                this.bindEvents();
                this.initializeGenerator(); // Load initial data and render
                this.renderThemes(); // Render theme buttons
                this.makeLevelsSortable();
                this.initMascot(); // Initialize mascot for the generator page
            },

            cacheElements() {
                const D = document;
                this.cache = {
                    browserTitleInput: D.getElementById('browserTitleInput'),
                    gameTitleInput: D.getElementById('gameTitleInput'),
                    copyrightTextInput: D.getElementById('copyrightTextInput'),
                    scorePerCaptureInput: D.getElementById('scorePerCapture'),
                    bonusItemScoreInput: D.getElementById('bonusItemScore'),
                    scaleFactorInput: D.getElementById('scaleFactor'),
                    objectConfigList: D.getElementById('object-config-list'),
                    addObjectBtn: D.getElementById('add-object-btn'),
                    levelConfigList: D.getElementById('level-config-list'),
                    addLevelBtn: D.getElementById('add-level-btn'),
                    generateConfigBtn: D.getElementById('generate-config-btn'),
                    downloadZipBtn: D.getElementById('download-zip-btn'),
                    indexTemplateContent: D.getElementById('indexTemplateContent'),
                    loader: D.getElementById('loader'),
                    loaderText: D.getElementById('loader-text'),
                    mascotGenerator: D.getElementById('mascot-generator'), // Cache mascot for generator
                    themeSelectionButtons: D.getElementById('theme-selection-buttons'),
                    toastNotification: D.getElementById('toast-notification') // New: Cache toast notification
                };
            },

            bindEvents() {
                // Delegate events for dynamically added/removed elements
                this.cache.objectConfigList.addEventListener('input', this._handleObjectInput.bind(this));
                this.cache.objectConfigList.addEventListener('change', this._handleObjectChange.bind(this));
                this.cache.objectConfigList.addEventListener('click', this._handleObjectClick.bind(this));

                this.cache.levelConfigList.addEventListener('input', this._handleLevelInput.bind(this));
                this.cache.levelConfigList.addEventListener('change', this._handleLevelChange.bind(this));
                this.cache.levelConfigList.addEventListener('click', this._handleLevelClick.bind(this));

                // Direct button clicks
                this.cache.addObjectBtn.addEventListener('click', this.addCaptureObject.bind(this));
                this.cache.addLevelBtn.addEventListener('click', this.addGameLevel.bind(this));
                this.cache.generateConfigBtn.addEventListener('click', this.generateGameConfig.bind(this));
                this.cache.downloadZipBtn.addEventListener('click', this.downloadGameZip.bind(this));

                // Global settings inputs (invalidate config on change)
                this.cache.browserTitleInput.addEventListener('input', () => this.state.generatedGameConfig = null);
                this.cache.gameTitleInput.addEventListener('input', () => this.state.generatedGameConfig = null);
                this.cache.copyrightTextInput.addEventListener('input', () => this.state.generatedGameConfig = null);
                this.cache.scorePerCaptureInput.addEventListener('input', () => this.state.generatedGameConfig = null);
                this.cache.bonusItemScoreInput.addEventListener('input', () => this.state.generatedGameConfig = null);
                this.cache.scaleFactorInput.addEventListener('input', () => this.state.generatedGameConfig = null);

                // Theme selection
                this.cache.themeSelectionButtons.addEventListener('click', this._handleThemeSelection.bind(this));
            },

            _handleObjectInput(e) {
                const target = e.target;
                const objId = target.dataset.objectId;
                const obj = this.state.objects.find(o => o.id === objId);
                if (!obj) return;
                this.state.generatedGameConfig = null; // Invalidate config on change

                if (target.classList.contains('object-name-input')) {
                    obj.name = target.value;
                    const nameDisplay = document.getElementById(`obj-name-display-${objId}`);
                    if (nameDisplay) nameDisplay.textContent = obj.name;
                    this.renderLevels(); // 名稱變更可能影響關卡中的選單顯示
                } else if (target.classList.contains('object-size-input')) {
                    obj.size = parseFloat(target.value);
                } else if (target.classList.contains('object-speed-input')) {
                    obj.speed = parseFloat(target.value);
                }
            },

            _handleObjectChange(e) {
                const target = e.target;
                const objId = target.dataset.objectId;
                const obj = this.state.objects.find(o => o.id === objId);
                if (!obj) return;
                this.state.generatedGameConfig = null; // Invalidate config on change

                if (target.classList.contains('object-image-input') && target.files.length > 0) {
                    const file = target.files[0];
                    obj.imageFile = file; // Store File object
                    const fileExtension = file.name.split('.').pop().toLowerCase(); // 確保小寫

                    // 為新上傳的檔案分配一個 itemNNN.ext 格式的檔名供顯示用
                    obj.displayFilename = `item${String(this.state._nextSequentialItemNumberForDisplay++).padStart(3, '0')}.${fileExtension}`;

                    const reader = new FileReader();
                    reader.onloadend = () => {
                        obj.imagePath = reader.result; // Data URL for preview
                        const imgPreview = document.getElementById(`img-preview-${objId}`);
                        if (imgPreview) {
                            imgPreview.src = reader.result;
                            imgPreview.classList.remove('hidden');
                        }
                        this.renderLevels(); // 圖片變更可能影響關卡中的選單顯示
                    };
                    reader.readAsDataURL(file);
                    this.renderObjects(); // 重新渲染以顯示更新後的「預計打包為」文字
                } else if (target.classList.contains('object-bonus-checkbox')) {
                    obj.isBonus = target.checked;
                }
            },

            _handleObjectClick(e) {
                const target = e.target.closest('.delete-object-btn');
                if (!target) return;
                const objId = target.dataset.objectId;
                const deletedObj = this.state.objects.find(obj => obj.id === objId);
                if (!deletedObj) return;
                this.state.generatedGameConfig = null; // Invalidate config on change

                const objectKeyToRemove = this._sanitizeId(deletedObj.name);
                this.state.objects = this.state.objects.filter(obj => obj.id !== objId);

                // 從所有關卡中移除這個物件
                this.state.levels.forEach(level => {
                    level.required = level.required.filter(id => id !== objectKeyToRemove);
                    level.forbidden = level.forbidden.filter(id => id !== objectKeyToRemove);
                });
                this.renderObjects(); // This will also trigger renderLevels()
            },

            _handleLevelInput(e) {
                const target = e.target;
                const levelId = target.dataset.levelId;
                const level = this.state.levels.find(l => l.id === levelId);
                if (!level) return;
                this.state.generatedGameConfig = null; // Invalidate config on change

                if (target.classList.contains('level-name-input')) {
                    level.name = target.value;
                    const nameDisplay = document.getElementById(`level-name-display-${levelId}`);
                    if (nameDisplay) nameDisplay.textContent = level.name;
                } else if (target.classList.contains('level-duration-input')) {
                    level.duration = parseFloat(target.value);
                } else if (target.classList.contains('level-object-count-input')) {
                    level.objectCount = parseFloat(target.value);
                } else if (target.classList.contains('level-speed-multiplier-input')) {
                    level.speedMultiplier = parseFloat(target.value);
                }
            },

            _handleLevelChange(e) {
                const target = e.target;
                if (!target.classList.contains('level-item-checkbox')) return;

                const levelId = target.dataset.levelId;
                const itemId = target.dataset.itemId; // Already sanitized
                const itemType = target.dataset.itemType;
                const level = this.state.levels.find(l => l.id === levelId);
                if (!level) return;
                this.state.generatedGameConfig = null; // Invalidate config on change

                if (target.checked) {
                    // Check for conflicts: cannot be both required and forbidden
                    if (itemType === 'target') {
                        if (level.forbidden.includes(itemId)) {
                            alert(`物品 "${this.state.objects.find(o => this._sanitizeId(o.name) === itemId)?.name || itemId}" 已被設為禁忌物品，不能同時設為目標物品。`);
                            target.checked = false; // Revert checkbox state
                            return;
                        }
                        if (!level.required.includes(itemId)) level.required.push(itemId);
                    } else if (itemType === 'forbidden') {
                        if (level.required.includes(itemId)) {
                            alert(`物品 "${this.state.objects.find(o => this._sanitizeId(o.name) === itemId)?.name || itemId}" 已被設為目標物品，不能同時設為禁忌物品。`);
                            target.checked = false; // Revert checkbox state
                            return;
                        }
                        if (!level.forbidden.includes(itemId)) level.forbidden.push(itemId);
                    }
                } else {
                    if (itemType === 'target') {
                        level.required = level.required.filter(id => id !== itemId);
                    } else if (itemType === 'forbidden') {
                        level.forbidden = level.forbidden.filter(id => id !== itemId);
                    }
                }
            },

            _handleLevelClick(e) {
                const target = e.target.closest('.delete-level-btn');
                if (!target) return;
                const levelId = target.dataset.levelId;
                this.state.levels = this.state.levels.filter(level => level.id !== levelId);
                this.renderLevels();
                this.state.generatedGameConfig = null; // Invalidate config on new level
            },

            _handleThemeSelection(e) {
                const target = e.target.closest('.theme-button');
                if (!target) return;

                const themeName = target.dataset.themeName;
                if (this.state.selectedTheme === themeName) return; // Already selected

                this.state.selectedTheme = themeName;
                this.renderThemes(); // Re-render to update active state
                this.state.generatedGameConfig = null; // Invalidate config on theme change
            },
            
            _sanitizeId(name) {
                let sanitized = name.toUpperCase().replace(/[^A-Z0-9_]/g, ''); // 只保留英數字和底線，並轉大寫

                // If still empty or too short, use a generic key based on a hash of the name
                if (sanitized.trim() === '' || sanitized.length < 3) {
                     return `ITEM_KEY_${Math.abs(this._stringHash(name)).toString(16).toUpperCase()}`;
                }
                return sanitized;
            },

            // Simple string hashing function
            _stringHash(s) {
                let hash = 0;
                for (let i = 0; i < s.length; i++) {
                    const char = s.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash |= 0; // Convert to 32bit integer
                }
                return hash;
            },

            _createObjectConfigHtml(obj, index) {
                const objectId = obj.id || `OBJ_${this.state.objectIdCounter++}`;
                obj.id = objectId; // Ensure object data has ID

                // 如果 obj.imagePath 為空或預設 GIF，則使用一個透明 GIF，否則使用設定的路徑
                const displayPath = obj.imagePath && obj.imagePath !== 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='
                    ? obj.imagePath
                    : 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';

                // displayFilename 已經是我們希望顯示的格式
                const currentFilePathText = obj.displayFilename ? `<p class="text-xs text-gray-500 mt-1">預計打包為: ${obj.displayFilename}</p>` : '';

                return `
                    <div class="card" data-object-id="${objectId}">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-800">物品 ${index + 1}: <span id="obj-name-display-${objectId}">${obj.name || ''}</span></h3>
                            <button class="btn-danger text-sm delete-object-btn" data-object-id="${objectId}"><i class="fas fa-trash"></i> 刪除</button>
                        </div>

                        <div class="mb-2">
                            <label class="block text-sm font-medium text-gray-700">物品名稱</label>
                            <input type="text" class="input-field mt-1 object-name-input" value="${obj.name || ''}" placeholder="例如: 月餅" data-object-id="${objectId}">
                        </div>
                        <div class="mb-2">
                            <label class="block text-sm font-medium text-gray-700">圖片上傳 (建議 PNG/SVG)</label>
                            <input type="file" accept="image/*" class="mt-1 object-image-input" data-object-id="${objectId}">
                            <img src="${displayPath}" class="image-preview mt-2 ${obj.imagePath ? '' : 'hidden'}" alt="預覽" id="img-preview-${objectId}" onerror="this.onerror=null;this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';this.classList.add('hidden');">
                            ${currentFilePathText}
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">預設大小 (像素)</label>
                                <input type="number" class="input-field mt-1 object-size-input" value="${obj.size || 30}" min="1" data-object-id="${objectId}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">基本速度 (倍數)</label>
                                <input type="number" class="input-field mt-1 object-speed-input" value="${obj.speed || 1.0}" step="0.1" min="0.1" data-object-id="${objectId}">
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" class="object-bonus-checkbox mr-2" ${obj.isBonus ? 'checked' : ''} id="obj-bonus-${objectId}" data-object-id="${objectId}">
                            <label for="obj-bonus-${objectId}" class="text-sm font-medium text-gray-700">是獎勵物品?</label>
                        </div>
                    </div>
                `;
            },

            _createLevelConfigHtml(level, index) {
                const levelId = level.id || `LEVEL_${index}`; // Use index as part of ID
                level.id = levelId;

                // Generate options for target and forbidden items
                const getObjectOptions = (selectedKeys, itemType) => {
                    return this.state.objects.map((obj) => {
                        const objectKey = this._sanitizeId(obj.name);
                        const isSelected = selectedKeys.includes(objectKey);
                        // Create unique id for each checkbox, link label
                        const checkboxId = `level-${levelId}-${itemType}-${objectKey}`;
                        // Disable checkbox if object name is empty or sanitized to empty string
                        const isDisabled = (!obj.name.trim() || this._sanitizeId(obj.name).trim() === '') ? 'disabled title="請先為物品命名並確保名稱有效"' : '';

                        // 如果 obj.imagePath 為空或預設 GIF，則使用一個透明 GIF，否則使用設定的路徑
                        const displayPath = obj.imagePath && obj.imagePath !== 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='
                            ? obj.imagePath
                            : 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';

                        return `
                            <label for="${checkboxId}" class="select-item">
                                <input type="checkbox" class="level-item-checkbox mr-2"
                                       id="${checkboxId}"
                                       data-level-id="${levelId}" data-item-id="${objectKey}"
                                       data-item-type="${itemType}" ${isSelected ? 'checked' : ''} ${isDisabled}>
                                <img src="${displayPath}" alt="${obj.name}" class="w-8 h-8 object-contain mr-2" onerror="this.onerror=null;this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
                                <span class="select-item-name">${obj.name || '未命名物品'}</span>
                            </label>
                        `;
                    }).join('');
                };

                return `
                    <div class="card" data-level-id="${levelId}">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-grip-vertical drag-handle"></i>
                                <h3 class="text-lg font-semibold text-gray-800">關卡 ${index + 1}: <span id="level-name-display-${levelId}">${level.name || ''}</span></h3>
                            </div>
                            <button class="btn-danger text-sm delete-level-btn" data-level-id="${levelId}"><i class="fas fa-trash"></i> 刪除</button>
                        </div>

                        <div class="mb-2">
                            <label class="block text-sm font-medium text-gray-700">關卡名稱</label>
                            <input type="text" class="input-field mt-1 level-name-input" value="${level.name || ''}" placeholder="例如: 輕鬆入門" data-level-id="${levelId}">
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">時間限制 (秒)</label>
                                <input type="number" class="input-field mt-1 level-duration-input" value="${level.duration || 10}" min="1" data-level-id="${levelId}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">物件總數</label>
                                <input type="number" class="input-field mt-1 level-object-count-input" value="${level.objectCount || 10}" min="1" data-level-id="${levelId}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">速度倍數</label>
                                <input type="number" class="input-field mt-1 level-speed-multiplier-input" value="${level.speedMultiplier || 1.0}" step="0.1" min="0.1" data-level-id="${levelId}">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">目標物品 (Required)</label>
                                <div class="border border-gray-300 rounded-md bg-white p-2 h-48 overflow-y-auto">
                                    ${getObjectOptions(level.required || [], 'target')}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">禁忌物品 (Forbidden)</label>
                                <div class="border border-gray-300 rounded-md bg-white p-2 h-48 overflow-y-auto">
                                    ${getObjectOptions(level.forbidden || [], 'forbidden')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderObjects() {
                this.cache.objectConfigList.innerHTML = this.state.objects.map(this._createObjectConfigHtml.bind(this)).join('');
                this.renderLevels(); // Items updated, so re-render levels to update selection lists
            },

            renderLevels() {
                this.cache.levelConfigList.innerHTML = this.state.levels.map(this._createLevelConfigHtml.bind(this)).join('');
                this.makeLevelsSortable();
            },

            renderThemes() {
                this.cache.themeSelectionButtons.innerHTML = Object.keys(this.CONFIG.THEMES).map(themeName => {
                    const isActive = this.state.selectedTheme === themeName;
                    return `<button type="button" class="theme-button ${isActive ? 'active' : ''}" data-theme-name="${themeName}">${themeName}</button>`;
                }).join('');
            },

            makeLevelsSortable() {
                // Destroy existing sortable instance if it exists to prevent re-initialization
                if (this._sortableInstance) {
                    this._sortableInstance.destroy();
                }
                this._sortableInstance = new Sortable(this.cache.levelConfigList, {
                    animation: 150,
                    handle: '.drag-handle',
                    onEnd: (evt) => {
                        const oldIndex = evt.oldIndex;
                        const newIndex = evt.newIndex;
                        const [movedItem] = this.state.levels.splice(oldIndex, 1);
                        this.state.levels.splice(newIndex, 0, movedItem);
                        this.renderLevels(); // Re-render to update displayed level numbers
                        this.state.generatedGameConfig = null; // Invalidate config on reorder
                    },
                });
            },

            addCaptureObject() {
                // 預設給予 PNG 擴展名，可根據實際情況調整
                const fileExtension = 'png';
                this.state.objects.push({
                    id: `OBJ_${this.state.objectIdCounter++}`,
                    name: `新物品 ${this.state.objects.length + 1}`,
                    imageFile: null,        // Store File object (for user uploads)
                    // 新增物品的 displayFilename 使用 itemNNN.ext 格式
                    displayFilename: `item${String(this.state._nextSequentialItemNumberForDisplay++).padStart(3, '0')}.${fileExtension}`,
                    imagePath: 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=', // Placeholder Data URL
                    size: 30,
                    speed: 1.0,
                    isBonus: false
                });
                this.renderObjects();
                this.state.generatedGameConfig = null; // Invalidate config on new object
            },

            addGameLevel() {
                this.state.levels.push({
                    id: `LEVEL_${this.state.levels.length}`,
                    name: `新關卡 ${this.state.levels.length + 1}`,
                    duration: 10,
                    objectCount: 10,
                    speedMultiplier: 1.0,
                    required: [],
                    forbidden: []
                });
                this.renderLevels();
                this.state.generatedGameConfig = null; // Invalidate config on new level
            },

            async generateGameConfig() {
                this.cache.loaderText.textContent = '正在生成遊戲配置，請稍候...';
                this.cache.loader.style.display = 'flex';

                let hasError = false;
                const gameConfig = {
                    GAME_TITLE: this.cache.gameTitleInput.value,
                    BROWSER_TITLE: this.cache.browserTitleInput.value,
                    COPYRIGHT_TEXT: this.cache.copyrightTextInput.value,
                    SCORE_PER_CAPTURE: parseFloat(this.cache.scorePerCaptureInput.value),
                    BONUS_ITEM_SCORE: parseFloat(this.cache.bonusItemScoreInput.value),
                    SCALE_FACTOR: parseFloat(this.cache.scaleFactorInput.value),
                    OBJECT_DEFINITIONS: {},
                    LEVELS: [],
                    THEME_STYLES: this.CONFIG.THEMES[this.state.selectedTheme] // Add selected theme styles
                };

                const usedObjectKeys = new Set();
                let itemFileCounterForZip = 1; // **專用於最終 ZIP 打包時的計數器**

                // Process object definitions
                for (const obj of this.state.objects) {
                    if (hasError) break;

                    if (!obj.name.trim()) {
                        alert(`物品必須命名！請檢查物品 ${obj.id}。`);
                        hasError = true;
                        break;
                    }
                    if (!obj.imageFile && (!obj.imagePath || obj.imagePath === 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=')) {
                        alert(`物品 "${obj.name}" 必須上傳圖片或有預設圖片內容！請檢查物品 ${obj.id}。`);
                        hasError = true;
                        break;
                    }

                    const objectKey = this._sanitizeId(obj.name);
                    if (usedObjectKeys.has(objectKey)) {
                        alert(`物品名稱 "${obj.name}" (處理後為 "${objectKey}") 重複了，請修改！`);
                        hasError = true;
                        break;
                    }
                    usedObjectKeys.add(objectKey);

                    // Determine file extension for the *final* bundled file
                    let fileExtension = 'png'; // Default extension for uploads or new items
                    if (obj.imageFile) {
                        fileExtension = obj.imageFile.name.split('.').pop().toLowerCase();
                    } else if (obj.imagePath.startsWith('data:image/svg') || obj.imagePath.endsWith('.svg')) { // 預設的相對路徑也會有 .svg
                        fileExtension = 'svg';
                    } else if (obj.imagePath.startsWith('data:image/png') || obj.imagePath.endsWith('.png')) {
                        fileExtension = 'png';
                    } else if (obj.imagePath.startsWith('data:image/jpeg') || obj.imagePath.endsWith('.jpg')) {
                        fileExtension = 'jpg';
                    }

                    // 為打包到 ZIP 中的檔案生成流水號名稱
                    const newFilenameInZip = `item/item${String(itemFileCounterForZip++).padStart(3, '0')}.${fileExtension}`;
                    
                    gameConfig.OBJECT_DEFINITIONS[objectKey] = {
                        path: newFilenameInZip, // 使用 itemNNN.ext 格式作為遊戲中的實際圖片路徑
                        size: obj.size * gameConfig.SCALE_FACTOR, // Apply scale factor here
                        speed: obj.speed,
                        name: obj.name,
                        isBonus: obj.isBonus,
                    };
                }

                if (hasError) {
                    this.state.generatedGameConfig = null;
                    this.cache.downloadZipBtn.disabled = true;
                    this.cache.loader.style.display = 'none';
                    return;
                }

                // Process level definitions
                for (const level of this.state.levels) {
                    if (hasError) break; // Check hasError from previous loop as well

                    if (!level.name.trim()) {
                        alert(`關卡必須命名！請檢查關卡 ${level.id}。`);
                        hasError = true;
                        break;
                    }
                    if (level.required.length === 0) {
                        alert(`關卡 "${level.name}" 必須至少有一個目標物品！`);
                        hasError = true;
                        break;
                    }

                    // Check if required and forbidden items are mutually exclusive
                    const conflictItems = level.required.filter(id => level.forbidden.includes(id));
                    if (conflictItems.length > 0) {
                        const conflictNames = conflictItems.map(id => this.state.objects.find(o => this._sanitizeId(o.name) === id)?.name || id).join(', ');
                        alert(`關卡 "${level.name}" 中，物品 "${conflictNames}" 既被設為目標物品又被設為禁忌物品。請修正！`);
                        hasError = true;
                        break;
                    }

                    gameConfig.LEVELS.push({
                        name: level.name,
                        duration: level.duration,
                        required: level.required,
                        forbidden: level.forbidden,
                        objectCount: level.objectCount,
                        speedMultiplier: level.speedMultiplier,
                    });
                }

                if (hasError) {
                    this.state.generatedGameConfig = null;
                    this.cache.downloadZipBtn.disabled = true;
                    this.cache.loader.style.display = 'none';
                    return;
                }

                this.state.generatedGameConfig = gameConfig; // Store the generated configuration
                this.cache.downloadZipBtn.disabled = false; // Enable download button
                this.showToast('配置生成成功！現在可以下載遊戲 ZIP 包了。', 'success');
                this.cache.loader.style.display = 'none';
            },

            async downloadGameZip() {
                if (!this.state.generatedGameConfig) {
                    this.showToast('請先生成配置！', 'warning');
                    return;
                }

                this.cache.loaderText.textContent = '正在打包遊戲檔案，請稍候...';
                this.cache.loader.style.display = 'flex';

                console.log("Starting ZIP generation...");
                const zip = new JSZip();
                const itemFolder = zip.folder("item");

                // 1. Add image files to item/ folder
                console.log("Adding object images to ZIP...");
                const objectDefinitions = this.state.generatedGameConfig.OBJECT_DEFINITIONS;

                for (const objectKey in objectDefinitions) {
                    if (!objectDefinitions.hasOwnProperty(objectKey)) continue;

                    const objDef = objectDefinitions[objectKey];
                    const originalObj = this.state.objects.find(o => this._sanitizeId(o.name) === objectKey);

                    if (!originalObj) {
                        console.warn(`Original object for key ${objectKey} not found in state.`);
                        continue;
                    }

                    const finalFilenameInZip = objDef.path.replace('item/', '');

                    if (originalObj.imageFile) {
                        console.log(`Adding uploaded file for ${originalObj.name} as item/${finalFilenameInZip}`);
                        itemFolder.file(finalFilenameInZip, originalObj.imageFile);
                    } else if (originalObj.imagePath.startsWith('data:')) {
                        try {
                            const base64Data = originalObj.imagePath.split(',')[1];
                            const mimeType = originalObj.imagePath.split(';')[0].split(':')[1];
                            const blob = this._base64toBlob(base64Data, mimeType);
                            itemFolder.file(finalFilenameInZip, blob);
                            console.log(`Added embedded image for ${originalObj.name} as item/${finalFilenameInZip}`);
                        } catch (e) {
                            console.error(`Error adding embedded image for ${originalObj.name}:`, e);
                            this.showToast(`無法加載內嵌圖片 "${originalObj.name}"。ZIP 生成失敗。`, 'error');
                            this.cache.loader.style.display = 'none';
                            return;
                        }
                    } else {
                        try {
                            const response = await fetch(originalObj.imagePath);
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            const blob = await response.blob();
                            itemFolder.file(finalFilenameInZip, blob);
                            console.log(`Added default image for ${originalObj.name} from path ${originalObj.imagePath} as item/${finalFilenameInZip}`);
                        } catch (e) {
                            console.error(`Error fetching default image for ${originalObj.name} from ${originalObj.imagePath}:`, e);
                            this.showToast(`無法加載預設圖片 "${originalObj.name}"。請確認 'item/' 資料夾內有對應的圖片檔案，或嘗試上傳新圖片。ZIP 生成失敗。`, 'error');
                            this.cache.loader.style.display = 'none';
                            return;
                        }
                    }
                }
                console.log("Object images added.");

                // 2. Get and modify index.html template (now read from DOM)
                console.log("Reading index.html template from DOM...");
                let indexHtmlContent = this.cache.indexTemplateContent.value;
                console.log("index.html template content read successfully.");

                // Replace global settings
                indexHtmlContent = indexHtmlContent.replace(/<!-- INSERT_BROWSER_TITLE_HERE -->/g, this.state.generatedGameConfig.BROWSER_TITLE);
                indexHtmlContent = indexHtmlContent.replace(/<!-- INSERT_GAME_TITLE_HERE -->/g, this.state.generatedGameConfig.GAME_TITLE);
                indexHtmlContent = indexHtmlContent.replace(/<!-- INSERT_GENERATED_COPYRIGHT_HTML_HERE -->/g, this.state.generatedGameConfig.COPYRIGHT_TEXT);

                // Insert theme CSS variables
                let themeCssVariables = ':root {\n';
                const themeStyles = this.state.generatedGameConfig.THEME_STYLES;
                for (const prop in themeStyles) {
                    if (themeStyles.hasOwnProperty(prop)) {
                        themeCssVariables += `  ${prop}: ${themeStyles[prop]};\n`;
                    }
                }
                themeCssVariables += '}\n';
                indexHtmlContent = indexHtmlContent.replace('<!-- INSERT_THEME_CSS_VARIABLES_HERE -->', themeCssVariables);

                // Replace JS variables
                const objectDefsString = JSON.stringify(this.state.generatedGameConfig.OBJECT_DEFINITIONS, null, 4);
                const levelsString = JSON.stringify(this.state.generatedGameConfig.LEVELS, null, 4);

                indexHtmlContent = indexHtmlContent.replace('/* <!-- INSERT_OBJECT_DEFINITIONS_HERE --> */', `const ORIGINAL_IMAGE_DEFINITIONS = ${objectDefsString};`);
                indexHtmlContent = indexHtmlContent.replace('/* <!-- INSERT_LEVELS_HERE --> */', `const LEVELS = ${levelsString};`);

                indexHtmlContent = indexHtmlContent.replace('/* <!-- INSERT_SCORE_PER_CAPTURE_HERE --> */', `const SCORE_PER_CAPTURE = ${this.state.generatedGameConfig.SCORE_PER_CAPTURE};`);
                indexHtmlContent = indexHtmlContent.replace('/* <!-- INSERT_BONUS_ITEM_SCORE_HERE --> */', `const BONUS_ITEM_SCORE = ${this.state.generatedGameConfig.BONUS_ITEM_SCORE};`);
                indexHtmlContent = indexHtmlContent.replace('/* <!-- INSERT_SCALE_FACTOR_HERE --> */', `const SCALE_FACTOR = ${this.state.generatedGameConfig.SCALE_FACTOR};`);

                zip.file("index.html", indexHtmlContent);
                console.log("index.html added to ZIP.");

                // 3. Generate and download ZIP
                console.log("Generating ZIP file...");
                try {
                    const content = await zip.generateAsync({ type: "blob" });
                    saveAs(content, "game_package.zip");
                    console.log("ZIP file 'game_package.zip' generated and downloaded successfully.");
                    this.showToast('遊戲 ZIP 包已成功下載！', 'success');
                } catch (e) {
                    console.error("ZIP 生成失敗:", e);
                    this.showToast("ZIP 生成失敗，請檢查瀏覽器開發者工具的 Console 訊息。", 'error');
                } finally {
                    this.cache.loader.style.display = 'none';
                }
            },

            // Helper function to convert Base64 to Blob (for embedded SVG data URLs)
            _base64toBlob(base64, mimeType) {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: mimeType });
            },

            showToast(message, type = 'info') {
                const toast = this.cache.toastNotification;
                toast.textContent = message;
                toast.className = 'hidden'; // Reset classes
                let bgColor = '#333'; // Default dark gray
                if (type === 'success') bgColor = '#4CAF50'; // Green
                else if (type === 'error') bgColor = '#F44336'; // Red
                else if (type === 'warning') bgColor = '#FFC107'; // Amber
                toast.style.backgroundColor = bgColor;
                toast.style.display = 'block'; // Make it visible
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10); // Small delay for transition to work

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', function handler() {
                        toast.style.display = 'none';
                        toast.removeEventListener('transitionend', handler);
                    });
                }, 3000); // Hide after 3 seconds
            },

            initializeGenerator() {
                // Pre-fill objectIdCounter to avoid ID conflicts with initial objects
                this.state.objectIdCounter = 5; // Start from 5 because we have 5 initial objects
                this.state._nextSequentialItemNumberForDisplay = 1; // 重置計數器，用於顯示「新增/上傳物品」的 itemNNN.ext 檔名

                // 預設物品的配置
                // imagePath 設為相對路徑，displayFilename 設為原始檔名
                this.state.objects = [
                    {
                        id: 'OBJ_0', name: '人生山耀', imageFile: null,
                        imagePath: 'item/人生山耀.svg', displayFilename: '人生山耀.svg',
                        size: 30, speed: 1.2, isBonus: false
                    },
                    {
                        id: 'OBJ_1', name: '好野將發', imageFile: null,
                        imagePath: 'item/好野將發.svg', displayFilename: '好野將發.svg',
                        size: 35, speed: 2.0, isBonus: false
                    },
                    {
                        id: 'OBJ_2', name: '蟹蟹有您', imageFile: null,
                        imagePath: 'item/蟹蟹有您.svg', displayFilename: '蟹蟹有您.svg',
                        size: 35, speed: 2.2, isBonus: false
                    },
                    {
                        id: 'OBJ_3', name: '祥旺來福', imageFile: null,
                        imagePath: 'item/祥旺來福.svg', displayFilename: '祥旺來福.svg',
                        size: 30, speed: 1.0, isBonus: true
                    },
                    {
                        id: 'OBJ_4', name: '窯身一變', imageFile: null,
                        imagePath: 'item/窯身一變.svg', displayFilename: '窯身一變.svg',
                        size: 30, speed: 1.6, isBonus: false
                    },
                ];

                // Levels' required and forbidden items directly use the sanitized ID results
                this.state.levels = [
                    { id: 'LEVEL_0', name: '初級挑戰', duration: 15, objectCount: 8, speedMultiplier: 1.0, required: [this._sanitizeId('人生山耀'), this._sanitizeId('好野將發')], forbidden: [this._sanitizeId('窯身一變')] },
                    { id: 'LEVEL_1', name: '中級考驗', duration: 12, objectCount: 12, speedMultiplier: 1.3, required: [this._sanitizeId('蟹蟹有您'), this._sanitizeId('祥旺來福')], forbidden: [this._sanitizeId('窯身一變')] },
                    { id: 'LEVEL_2', name: '終極撈撈', duration: 10, objectCount: 15, speedMultiplier: 1.6, required: [this._sanitizeId('人生山耀'), this._sanitizeId('好野將發'), this._sanitizeId('蟹蟹有您')], forbidden: [this._sanitizeId('窯身一變')] }
                ];

                this.renderObjects();
                // renderLevels is called by renderObjects, so no need to call it directly here.
            },

            initMascot() {
                let clickCount = 0;
                // Only initialize if the mascot element exists on the generator page
                if (this.cache.mascotGenerator) {
                    this.cache.mascotGenerator.addEventListener("click", (e) => {
                        this.cache.mascotGenerator.classList.add("shake");
                        setTimeout(() => this.cache.mascotGenerator.classList.remove("shake"), 500);

                        // Particle effect
                        const rect = this.cache.mascotGenerator.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;

                        for (let i = 0; i < 12; i++) {
                            const p = document.createElement("div");
                            p.className = "particle";
                            p.style.backgroundColor = ["#3b82f6", "#ef4444", "#8b5cf6", "#fde047", "#10b981"][Math.floor(5 * Math.random())];
                            p.style.left = centerX + "px";
                            p.style.top = centerY + "px";
                            const dx = 100 * (Math.random() - 0.5);
                            const dy = 100 * (Math.random() - 0.5);
                            p.style.setProperty('--dx', dx + "px");
                            p.style.setProperty('--dy', dy + "px");
                            document.body.appendChild(p);
                            setTimeout(() => p.remove(), 1000);
                        }

                        // Optional: special interaction after multiple clicks
                        clickCount++;
                        if (clickCount >= 5) {
                            this.showToast('LiyuChillGuy說：別再點我啦！專心設定遊戲喔！', 'info');
                            clickCount = 0; // Reset
                        }
                    });
                }
            }
        };

        // Initialize the App when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>